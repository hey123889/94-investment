<!DOCTYPE html>
<!--
  æŠ•è³‡è¦åŠƒèˆ‡ç¸¾æ•ˆè¿½è¹¤å™¨ v3.2
  æ›´æ–°æ—¥æœŸï¼š2026-01-22

  v3.2 æ›´æ–°ï¼š
  - ç°¡åŒ–ã€Œæ­·å²å›é¡§ã€ï¼šç§»é™¤è¿‘æœŸ/é•·æœŸç¸¾æ•ˆè¨ˆç®—ï¼ˆéœ€è¦å¯†é›†è³‡æ–™æ‰æœ‰æ„ç¾©ï¼‰
  - ç§»é™¤ IRR è¨ˆç®—ï¼ˆéœ€è¦å®Œæ•´ç¾é‡‘æµç´€éŒ„ï¼‰
  - ä¿ç•™ï¼šç¸½æŠ•å…¥ã€ç›®å‰è³‡ç”¢ã€ç¸½ç²åˆ©ã€æŠ•è³‡æœŸé–“

  v3.1 æ›´æ–°ï¼š
  - æ–°å¢ã€Œå¿«é€Ÿè¨˜éŒ„ä»Šæ—¥æ”¶ç›Šã€åŠŸèƒ½
  - æ–°å¢å¤šç”¨æˆ¶æ”¯æ´ï¼ˆå¯åˆ‡æ›ä¸åŒç”¨æˆ¶ï¼‰
  - æ–°å¢é€£ç·šæ¸¬è©¦åŠŸèƒ½
  - ä¿®æ­£å…ˆç§Ÿå¾Œè²·è²·æˆ¿å¹´è¨ˆç®—
  - Google Sheet ä½œç‚ºå”¯ä¸€è³‡æ–™ä¾†æº

  åŠŸèƒ½æ•´åˆï¼š
  - æ­·å²è³‡æ–™è¿½è¹¤ï¼ˆGoogle Sheet é›™å‘åŒæ­¥ï¼‰
  - æŠ•è³‡è¦åŠƒæ¨¡æ“¬ï¼ˆä½æˆ¿ç­–ç•¥ã€é€€ä¼‘è¦åŠƒï¼‰
  - åœ–è¡¨åˆä½µï¼ˆæ­·å²è»Œè·¡ + é æ¸¬ç·šï¼‰
  - é‡Œç¨‹ç¢‘è¿½è¹¤
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æŠ•è³‡è¦åŠƒèˆ‡ç¸¾æ•ˆè¿½è¹¤å™¨ v3.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ================================================================
         * CSS æ¨£å¼å€å¡Š
         * ================================================================
         *
         * çµæ§‹æ¦‚è¦½ï¼š
         *   1. CSS è®Šæ•¸ (:root)          - é¡è‰²ã€åœ“è§’ã€é™°å½±ç­‰å…¨åŸŸè®Šæ•¸
         *   2. åŸºç¤æ¨£å¼                   - body, header, container
         *   3. æ­¥é©Ÿå€å¡Š (.step)           - å¯æŠ˜ç–Šçš„è¨­å®šé¢æ¿
         *   4. è¡¨å–®å…ƒç´                    - input, select, label
         *   5. æŒ‰éˆ•æ¨£å¼ (.btn)            - primary, secondary, danger
         *   6. ç‹€æ…‹è¨Šæ¯ (.status)         - success, error, loading
         *   7. æ­·å²å›é¡§ (.history-summary) - ç¸½è¦½ã€ç´€éŒ„åˆ—è¡¨
         *   8. å¿«é€Ÿè¨˜éŒ„ (.quick-record)   - å¿«é€Ÿè¼¸å…¥å€
         *   9. åœ–è¡¨å€åŸŸ (.chart-container) - Chart.js åœ–è¡¨
         *   10. é‡Œç¨‹ç¢‘ (.milestones)      - ç›®æ¨™é”æˆåˆ—è¡¨
         *   11. éŸ¿æ‡‰å¼è¨­è¨ˆ (@media)       - æ‰‹æ©Ÿç‰ˆé©é…
         *
         * é¡è‰²ç³»çµ±ï¼š
         *   --color-primary: #00d4ff (é’è‰²ï¼Œä¸»è‰²)
         *   --color-success: #2ecc71 (ç¶ è‰²ï¼Œæ­£å‘)
         *   --color-warning: #f39c12 (æ©™è‰²ï¼Œè­¦å‘Š)
         *   --color-danger:  #e74c3c (ç´…è‰²ï¼Œå±éšª)
         * ================================================================ */

        /* --------------------------------
         * 1. CSS è®Šæ•¸
         * -------------------------------- */
        :root {
            --color-bg: #1a1a2e;
            --color-bg-light: #16213e;
            --color-primary: #00d4ff;
            --color-text: #eee;
            --color-text-muted: #888;
            --color-success: #2ecc71;
            --color-warning: #f39c12;
            --color-danger: #e74c3c;
            --color-purple: #9b59b6;
            --color-orange: #e67e22;
            --color-blue: #3498db;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* --------------------------------
         * 2. åŸºç¤æ¨£å¼
         * -------------------------------- */
        * {
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            /* æ”¯æ´ iPhone ç€æµ·å’Œåº•éƒ¨å®‰å…¨å€åŸŸ */
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-bg-light) 100%);
            min-height: 100vh;
            color: var(--color-text);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--color-primary);
            text-shadow: 0 0 20px rgba(0,212,255,0.5);
            margin: 0;
            font-size: 2em;
        }

        .header .subtitle {
            color: var(--color-text-muted);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .user-info-summary {
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            display: inline-flex;
            gap: 8px;
            font-size: 14px;
        }

        .user-info-summary .separator {
            color: rgba(255,255,255,0.3);
        }

        .user-info-summary strong {
            color: var(--color-primary);
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 25px;
        }

        /* --------------------------------
         * 3. æ­¥é©Ÿå€å¡Š (.step)
         * å¯æŠ˜ç–Šçš„è¨­å®šé¢æ¿ï¼Œæ¯å€‹æ­¥é©Ÿæœ‰ä¸åŒé¡è‰²
         * é»æ“Š header å¯å±•é–‹/æ”¶åˆ
         * -------------------------------- */
        .step {
            background: rgba(255,255,255,0.08);
            border-radius: var(--radius);
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .step-header {
            padding: 12px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .step-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .step-number {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }

        .step-title {
            flex: 1;
            font-weight: bold;
            font-size: 1em;
        }

        .step-toggle {
            font-size: 12px;
            color: var(--color-text-muted);
            transition: transform 0.3s;
        }

        .step.collapsed .step-toggle {
            transform: rotate(-90deg);
        }

        .step-content {
            padding: 5px 18px 18px 18px;
            transition: all 0.3s;
        }

        .step.collapsed .step-content {
            display: none;
        }

        /* å„æ­¥é©Ÿé¡è‰² */
        .step-data .step-number { background: var(--color-purple); }
        .step-basic .step-number { background: var(--color-blue); }
        .step-housing .step-number { background: var(--color-success); }
        .step-retire .step-number { background: var(--color-orange); }
        .step-events .step-number { background: var(--color-danger); }
        .step-tools .step-number { background: var(--color-text-muted); }
        .step-quick .step-number { background: var(--color-warning); }

        /* --------------------------------
         * 4. è¡¨å–®å…ƒç´ 
         * .form-grid: å…©æ¬„å¼è¡¨å–®ä½ˆå±€
         * .form-group: å–®ä¸€è¡¨å–®é …ç›® (label + input)
         * -------------------------------- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            font-size: 13px;
            color: var(--color-text-muted);
            margin-bottom: 4px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: var(--color-text);
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .form-hint {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-top: 3px;
        }

        /* --------------------------------
         * 5. æŒ‰éˆ•æ¨£å¼
         * .btn-primary: ä¸»è¦æ“ä½œï¼ˆè—æ¼¸å±¤ï¼‰
         * .btn-secondary: æ¬¡è¦æ“ä½œï¼ˆåŠé€æ˜ï¼‰
         * .btn-danger: å±éšªæ“ä½œï¼ˆç´…è‰²ï¼‰
         * -------------------------------- */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-blue));
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--color-text);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.2);
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.3);
        }

        /* --------------------------------
         * 6. ç‹€æ…‹è¨Šæ¯
         * ç”¨æ–¼é¡¯ç¤ºæ“ä½œçµæœ
         * .success: ç¶ è‰²ï¼ˆæˆåŠŸï¼‰
         * .error: ç´…è‰²ï¼ˆå¤±æ•—ï¼‰
         * .loading: é»ƒè‰²ï¼ˆè¼‰å…¥ä¸­ï¼‰
         * -------------------------------- */
        .status {
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .status.success {
            display: block;
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid var(--color-success);
            color: var(--color-success);
        }

        .status.error {
            display: block;
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
        }

        .status.loading {
            display: block;
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid var(--color-warning);
            color: var(--color-warning);
        }

        /* --------------------------------
         * 7. è³‡æ–™ä¾†æºå€å¡Š
         * Google Sheet é€£ç·šè¨­å®š
         * -------------------------------- */
        .data-source-section {
            margin-bottom: 12px;
        }

        .data-source-section .section-title {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-bottom: 8px;
        }

        .data-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .data-buttons .btn {
            width: 100%;
        }

        /* --------------------------------
         * 8. æ­·å²å›é¡§å€å¡Š
         * é¡¯ç¤ºæŠ•è³‡ç¸½è¦½ï¼ˆç¸½æŠ•å…¥ã€ç¾å€¼ã€ç²åˆ©ï¼‰
         * åŒ…å«æ­·å²ç´€éŒ„åˆ—è¡¨
         * -------------------------------- */
        .history-summary {
            background: rgba(155, 89, 182, 0.15);
            border: 1px solid var(--color-purple);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            display: none;
        }

        .history-summary.active {
            display: block;
        }

        .history-summary .title {
            font-weight: bold;
            color: var(--color-purple);
            margin-bottom: 8px;
            font-size: 15px;
        }

        .history-summary .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            text-align: center;
        }

        .history-summary .stat-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .history-summary .stat-label {
            font-size: 12px;
            color: var(--color-text-muted);
        }

        .history-summary .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--color-primary);
        }

        .history-summary .stat-value.irr {
            color: var(--color-success);
        }

        /* æ­·å²å›é¡§ - ç¸½è¦½ */
        .history-overview {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .overview-main {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            text-align: center;
            margin-bottom: 8px;
        }

        .overview-item .label {
            font-size: 11px;
            color: var(--color-text-muted);
            display: block;
        }

        .overview-item .value {
            font-size: 16px;
            font-weight: bold;
            color: var(--color-text);
        }

        .overview-item .value.highlight {
            color: var(--color-primary);
        }

        .overview-item .value.profit {
            color: var(--color-success);
        }

        .overview-sub {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--color-text-muted);
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .overview-sub strong {
            color: var(--color-text);
        }

        .history-summary .apply-btn {
            margin-top: 10px;
            width: 100%;
        }

        /* æ­·å²ç´€éŒ„åˆ—è¡¨ */
        .history-list-toggle {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            color: var(--color-text-muted);
            transition: all 0.2s;
        }

        .history-list-toggle:hover {
            background: rgba(0,0,0,0.3);
            color: var(--color-text);
        }

        .history-list-container {
            margin-top: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .history-list-container.expanded {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .history-table th {
            background: rgba(0,0,0,0.3);
            color: var(--color-primary);
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .history-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .history-table .note {
            text-align: left;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-table .delete-btn {
            color: var(--color-danger);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .history-table .delete-btn:hover {
            opacity: 1;
        }

        /* --------------------------------
         * 9. ä½æˆ¿ç­–ç•¥å€å¡Š
         * .strategy-options: ç­–ç•¥é¸æ“‡æŒ‰éˆ•ï¼ˆè²·æˆ¿/ç§Ÿæˆ¿/å…ˆç§Ÿå¾Œè²·ï¼‰
         * .strategy-config: å„ç­–ç•¥çš„è©³ç´°è¨­å®š
         * .compare-mode: è²·ç§Ÿæ¯”è¼ƒæ¨¡å¼
         * -------------------------------- */
        .strategy-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .strategy-option {
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .strategy-option:hover {
            border-color: rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.05);
        }

        .strategy-option.selected {
            border-color: var(--color-success);
            background: rgba(46, 204, 113, 0.15);
        }

        .strategy-option .icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .strategy-option .name {
            font-weight: bold;
            font-size: 14px;
        }

        .strategy-option .desc {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        /* ç­–ç•¥è¨­å®šå€å¡Š */
        .strategy-config {
            display: none;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin-top: 12px;
        }

        .strategy-config.active {
            display: block;
        }

        .strategy-config h4 {
            margin: 0 0 12px 0;
            color: var(--color-success);
            font-size: 13px;
        }

        /* å…ˆç§Ÿå¾Œè²·çš„å…©éšæ®µ */
        .phase-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .phase-box h5 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: var(--color-warning);
        }

        .phase-arrow {
            text-align: center;
            color: var(--color-text-muted);
            padding: 4px 0;
            font-size: 18px;
        }

        /* æ¯”è¼ƒæ¨¡å¼ */
        .compare-mode {
            margin-top: 15px;
            padding: 12px;
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid var(--color-warning);
            border-radius: 10px;
        }

        .compare-mode h4 {
            margin: 0 0 8px 0;
            color: var(--color-warning);
            font-size: 13px;
        }

        .compare-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .compare-toggle label {
            font-size: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            transition: .3s;
            border-radius: 22px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-warning);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        .compare-options {
            display: none;
        }

        .compare-options.active {
            display: block;
        }

        .compare-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 12px;
        }

        .compare-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--color-warning);
        }

        /* --------------------------------
         * 10. è¨ˆç®—æ‘˜è¦å€å¡Š
         * é¡¯ç¤ºä½æˆ¿è¨ˆç®—çµæœï¼ˆæœˆä¾›ã€ç¸½åˆ©æ¯ç­‰ï¼‰
         * -------------------------------- */
        .calc-summary {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .calc-summary .title {
            color: var(--color-warning);
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .calc-summary .item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 3px 0;
        }

        .calc-summary .item .value {
            color: var(--color-primary);
            font-weight: bold;
        }

        .calc-summary .highlight {
            background: rgba(255, 215, 0, 0.15);
            padding: 10px;
            border-radius: 5px;
            margin-top: 8px;
            text-align: center;
        }

        .calc-summary .highlight .big {
            font-size: 18px;
            color: var(--color-warning);
            font-weight: bold;
        }

        /* --------------------------------
         * 11. ç‰¹æ®Šç¾é‡‘æµäº‹ä»¶
         * .event-list: äº‹ä»¶åˆ—è¡¨å®¹å™¨
         * .event-item: å–®ä¸€äº‹ä»¶ï¼ˆæ”¶å…¥/æ”¯å‡ºï¼‰
         * .quick-btns: å¿«é€Ÿæ–°å¢æŒ‰éˆ•ï¼ˆå¹´çµ‚ã€æ—…éŠç­‰ï¼‰
         * -------------------------------- */
        .event-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 8px;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .event-item .delete-btn {
            background: var(--color-danger);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }

        .quick-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .quick-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: var(--color-text);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .quick-btn.income {
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .quick-btn.expense {
            border-color: var(--color-danger);
            color: var(--color-danger);
        }

        .quick-label {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-right: 4px;
        }

        /* äº‹ä»¶é¡å‹åˆ‡æ› */
        .event-type-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .type-btn {
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: transparent;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .type-btn:hover {
            border-color: rgba(255,255,255,0.4);
        }

        .type-btn.active[data-type="income"] {
            border-color: var(--color-success);
            background: rgba(46, 204, 113, 0.15);
            color: var(--color-success);
        }

        .type-btn.active[data-type="expense"] {
            border-color: var(--color-danger);
            background: rgba(231, 76, 60, 0.15);
            color: var(--color-danger);
        }

        /* äº‹ä»¶é …ç›®æ¨£å¼ */
        .event-item.income {
            border-left: 3px solid var(--color-success);
        }

        .event-item.expense {
            border-left: 3px solid var(--color-danger);
        }

        .event-item .event-amount {
            font-weight: bold;
        }

        .event-item .event-amount.positive {
            color: var(--color-success);
        }

        .event-item .event-amount.negative {
            color: var(--color-danger);
        }

        /* --------------------------------
         * 12. åŒ¯å‡ºå½ˆçª—ï¼ˆç›®å‰æœªä½¿ç”¨ï¼‰
         * åŸæœ¬ç”¨æ–¼åŒ¯å‡ºè³‡æ–™ï¼Œå·²æ”¹ç‚º Sheet åŒæ­¥
         * -------------------------------- */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .export-modal-content {
            background: var(--color-bg-light);
            border-radius: var(--radius);
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .export-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .export-modal-header h3 {
            margin: 0;
            color: var(--color-primary);
            font-size: 1.1em;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--color-text);
        }

        .export-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .export-tab {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: transparent;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .export-tab:hover {
            border-color: rgba(255,255,255,0.4);
        }

        .export-tab.active {
            border-color: var(--color-primary);
            background: rgba(0, 212, 255, 0.15);
            color: var(--color-primary);
        }

        .export-instructions {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 12px;
            color: var(--color-text-muted);
        }

        .export-content {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre;
            overflow-x: auto;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 250px;
            overflow-y: auto;
        }

        /* --------------------------------
         * 13. å¿«é€Ÿè¨˜éŒ„å€å¡Š
         * âš ï¸ é™åˆ¶èªªæ˜ï¼š
         *   æ­¤åŠŸèƒ½è¨˜éŒ„ã€Œç´¯è¨ˆæˆæœ¬ã€èˆ‡ã€Œç•¶å‰è³‡ç”¢ã€çš„å¿«ç…§
         *   ä¸é©åˆç”¨ä¾†è¨ˆç®—ç²¾ç¢ºçš„æ™‚é–“åŠ æ¬Šå ±é…¬ï¼ˆIRRï¼‰
         *   å› ç‚ºæ²’æœ‰è¨˜éŒ„æ¯ç­†å®šæœŸå®šé¡çš„æŠ•å…¥æ™‚é–“
         *
         * é©ç”¨å ´æ™¯ï¼š
         *   - å®šæœŸè¨˜éŒ„è³‡ç”¢ç‹€æ…‹ï¼ˆå¦‚æ¯æœˆåº•ï¼‰
         *   - è¿½è¹¤è³‡ç”¢æˆé•·è»Œè·¡
         *   - ä¸éœ€ç²¾ç¢ºç¸¾æ•ˆè¨ˆç®—çš„æƒ…æ³
         * -------------------------------- */
        .quick-record-section {
            background: rgba(46, 204, 113, 0.08);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 10px;
            padding: 14px;
        }

        .quick-record-section .section-title {
            font-size: 13px;
            font-weight: bold;
            color: var(--color-success);
            margin-bottom: 10px;
        }

        .quick-record-result {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            display: none;
        }

        .quick-record-result.active {
            display: block;
        }

        .quick-record-result .profit {
            font-weight: bold;
        }

        .quick-record-result .profit.positive {
            color: var(--color-success);
        }

        .quick-record-result .profit.negative {
            color: var(--color-danger);
        }

        /* --------------------------------
         * 14. Sheet é€£æ¥è¨­å®š
         * Google Sheet ID å’Œ Apps Script URL è¼¸å…¥
         * -------------------------------- */
        .sheet-connection-section {
            margin-top: 12px;
        }

        .sheet-connection-section .section-title {
            font-size: 13px;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        /* ç”¨æˆ¶é¸æ“‡å™¨ï¼ˆæœ€ä¸Šå±¤ï¼‰ */
        .user-selector-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .user-selector {
            display: flex;
            gap: 10px;
        }

        .user-option {
            padding: 8px 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 13px;
            background: rgba(0,0,0,0.2);
        }

        .user-option:hover {
            border-color: rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.05);
        }

        .user-option.selected {
            border-color: var(--color-primary);
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .user-option .user-name {
            font-weight: bold;
            color: var(--color-text);
        }

        .user-option.selected .user-name {
            color: var(--color-primary);
        }

        .user-option .user-info {
            font-size: 10px;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .user-option.user-add {
            border-style: dashed;
            opacity: 0.7;
        }

        .user-option.user-add:hover {
            opacity: 1;
            border-color: var(--color-success);
        }

        .user-option.user-add .user-name {
            color: var(--color-success);
        }

        .user-option {
            position: relative;
        }

        .user-delete {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: var(--color-danger);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .user-option:hover .user-delete {
            opacity: 1;
        }

        .user-delete:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* å·¥å…·å€å¡Š */
        .tool-section {
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .tool-section h4 {
            margin: 0 0 10px 0;
            font-size: 15px;
            color: var(--color-text-muted);
        }

        .tool-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: rgba(255,255,255,0.15);
        }

        .tool-result {
            margin-top: 10px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .tool-result.active {
            display: block;
        }

        /* --------------------------------
         * 15. å³å´é¢æ¿ï¼ˆåœ–è¡¨èˆ‡çµ±è¨ˆï¼‰
         * .chart-panel: ä¸»è¦åœ–è¡¨å€
         * .stats-panel: æ•´åˆé‡Œç¨‹ç¢‘èˆ‡é—œéµå¹´é½¡é æ¸¬
         * -------------------------------- */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* åœ–è¡¨å€åŸŸ */
        .chart-panel {
            background: rgba(255,255,255,0.08);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .chart-panel h2 {
            margin: 0 0 15px 0;
            color: var(--color-primary);
            font-size: 1.4em;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        /* çµ±è¨ˆå€å¡Šï¼ˆæ•´åˆé‡Œç¨‹ç¢‘èˆ‡å¹´é½¡é æ¸¬ï¼‰ */
        .stats-panel {
            background: rgba(255,255,255,0.08);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stats-panel h3 {
            color: var(--color-primary);
            margin: 0 0 15px 0;
            font-size: 1.2em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 14px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
        }

        .stat-item .label {
            font-size: 13px;
            color: var(--color-text-muted);
            margin-bottom: 6px;
        }

        .stat-item .value {
            font-size: 18px;
            font-weight: bold;
            color: var(--color-primary);
        }

        .stat-item .info {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        /* é‡Œç¨‹ç¢‘æ¨£å¼ */
        .stat-item.milestone-achieved {
            background: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.4);
        }

        .stat-item.milestone-achieved .value {
            color: var(--color-success);
        }

        .stat-item.milestone-pending {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item.milestone-pending .value {
            color: var(--color-text-muted);
        }

        /* é—œéµå¹´é½¡æ¨£å¼ */
        .stat-item.age-item {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .stat-item.highlight-retire {
            background: rgba(230, 126, 34, 0.15);
            border: 1px solid rgba(230, 126, 34, 0.5);
        }

        .stat-item.highlight-retire .label {
            color: var(--color-orange);
        }

        /* åˆ†éš”ç·š */
        .stats-divider {
            grid-column: 1 / -1;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        /* åˆ†æå€å¡Š */
        .analysis-box {
            margin-top: 12px;
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
        }

        .analysis-box.buy { background: rgba(46, 204, 113, 0.15); border: 1px solid var(--color-success); }
        .analysis-box.rent { background: rgba(155, 89, 182, 0.15); border: 1px solid var(--color-purple); }
        .analysis-box.compare { background: rgba(241, 196, 15, 0.15); border: 1px solid var(--color-warning); }
        .analysis-box.retire { background: rgba(230, 126, 34, 0.15); border: 1px solid var(--color-orange); }

        .analysis-box h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
        }

        .analysis-box .content {
            line-height: 1.6;
        }

        /* --------------------------------
         * 16. éŸ¿æ‡‰å¼è¨­è¨ˆ
         * ä¸‰å€‹æ–·é»ï¼š1000pxï¼ˆå¹³æ¿æ©«å‘ï¼‰ã€768pxï¼ˆå¹³æ¿ç›´å‘ï¼‰ã€480pxï¼ˆæ‰‹æ©Ÿï¼‰
         * -------------------------------- */

        /* === å¹³æ¿æ©«å‘ä»¥ä¸‹ (< 1000px) === */
        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
                padding: 0 15px;
            }

            .strategy-options {
                grid-template-columns: 1fr 1fr;
            }

            .chart-container {
                height: 350px;
            }
        }

        /* === å¹³æ¿ç›´å‘ä»¥ä¸‹ (< 768px) === */
        @media (max-width: 768px) {
            /* æ¨™é¡Œå€åŸŸ */
            .header h1 {
                font-size: 1.4em;
            }

            .header .subtitle {
                font-size: 0.85em;
            }

            /* ç”¨æˆ¶è³‡è¨Šæ”¹ç‚ºæ›è¡Œé¡¯ç¤º */
            .user-info-summary {
                flex-wrap: wrap;
                justify-content: center;
                gap: 6px 12px;
                font-size: 13px;
                padding: 10px 12px;
            }

            .user-info-summary .separator {
                display: none;
            }

            /* ç”¨æˆ¶é¸æ“‡å™¨ */
            .user-selector {
                flex-wrap: wrap;
                justify-content: center;
            }

            .user-option {
                padding: 10px 16px;
                font-size: 14px;
            }

            /* è¡¨å–®å€åŸŸ */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .form-group label {
                font-size: 14px;
            }

            .form-group input, .form-group select {
                padding: 12px;
                font-size: 16px; /* é¿å… iOS è‡ªå‹•ç¸®æ”¾ */
            }

            /* æ­¥é©Ÿå€å¡Š */
            .step-header {
                padding: 14px 16px;
            }

            .step-content {
                padding: 10px 16px 16px 16px;
            }

            .step-title {
                font-size: 1.05em;
            }

            /* æŒ‰éˆ•åŠ å¤§è§¸æ§å€åŸŸ */
            .btn {
                padding: 12px 18px;
                font-size: 15px;
                min-height: 44px; /* Apple å»ºè­°æœ€å°è§¸æ§å€åŸŸ */
            }

            .data-buttons {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* ç­–ç•¥é¸é … */
            .strategy-options {
                grid-template-columns: 1fr;
            }

            .strategy-option {
                padding: 14px;
            }

            .strategy-option .name {
                font-size: 15px;
            }

            .strategy-option .desc {
                font-size: 13px;
            }

            /* æ»‘æ¡¿åŠ å¤§è§¸æ§å€åŸŸ */
            input[type="range"] {
                height: 8px;
            }

            input[type="range"]::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }

            /* åœ–è¡¨å€åŸŸ */
            .chart-panel {
                padding: 15px;
            }

            .chart-panel h2 {
                font-size: 1.2em;
            }

            .chart-container {
                height: 300px;
            }

            /* çµ±è¨ˆå€å¡Š */
            .stats-panel {
                padding: 15px;
            }

            .stats-panel h3 {
                font-size: 1.1em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-item {
                padding: 12px 8px;
            }

            .stat-item .label {
                font-size: 12px;
            }

            .stat-item .value {
                font-size: 16px;
            }

            /* æ­·å²å›é¡§ */
            .history-summary .stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .overview-main {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .overview-item .label {
                font-size: 12px;
            }

            .overview-item .value {
                font-size: 18px;
            }

            /* å¿«é€ŸæŒ‰éˆ• */
            .quick-btns {
                gap: 8px;
            }

            .quick-btn {
                padding: 10px 14px;
                font-size: 14px;
            }

            /* äº‹ä»¶é¡å‹åˆ‡æ› */
            .event-type-toggle {
                gap: 10px;
            }

            .type-btn {
                padding: 12px;
                font-size: 15px;
            }

            /* äº‹ä»¶é …ç›® */
            .event-item {
                padding: 10px 12px;
                font-size: 14px;
            }

            .event-item .delete-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            /* æ¨¡æ…‹è¦–çª— */
            .export-modal-content {
                width: 95%;
                padding: 15px;
                max-height: 85vh;
            }

            .export-modal-header h3 {
                font-size: 1em;
            }

            /* è¨ˆç®—æ‘˜è¦ */
            .calc-summary .item {
                font-size: 14px;
                padding: 5px 0;
            }

            .calc-summary .highlight .big {
                font-size: 20px;
            }

            /* åˆ†æå€å¡Š */
            .analysis-box {
                padding: 14px;
                font-size: 13px;
            }
        }

        /* === æ‰‹æ©Ÿ (< 480px) === */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 15px 10px;
            }

            .header h1 {
                font-size: 1.2em;
            }

            /* ç”¨æˆ¶é¸æ“‡å™¨å‚ç›´æ’åˆ— */
            .user-selector-wrapper {
                margin-top: 10px;
            }

            .user-selector {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .user-option {
                width: 100%;
                padding: 12px;
            }

            /* å®¹å™¨ç„¡é–“è· */
            .container {
                gap: 15px;
                padding: 0 10px;
            }

            /* æ­¥é©Ÿå€å¡Šç·Šæ¹Š */
            .step {
                margin-bottom: 12px;
            }

            .step-header {
                padding: 12px 14px;
            }

            .step-content {
                padding: 8px 14px 14px 14px;
            }

            /* çµ±è¨ˆæ ¼ç·šæ”¹ç‚ºå–®æ¬„ */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .stat-item .value {
                font-size: 15px;
            }

            /* åœ–è¡¨æ›´ç·Šæ¹Š */
            .chart-panel {
                padding: 12px;
            }

            .chart-container {
                height: 250px;
            }

            /* éš±è—ä¸é‡è¦çš„æ–‡å­— */
            .form-hint {
                font-size: 11px;
            }

            /* æ­·å²ç´€éŒ„è¡¨æ ¼ */
            .history-table {
                font-size: 11px;
            }

            .history-table th,
            .history-table td {
                padding: 5px 4px;
            }

            .history-table .note {
                max-width: 50px;
            }

            /* å¿«é€Ÿè¨˜éŒ„ */
            .quick-record-section {
                padding: 12px;
            }

            /* å·¥å…·å€å¡Š */
            .tool-section {
                padding: 10px;
            }

            .tool-btn {
                padding: 12px;
                font-size: 15px;
            }
        }

        /* === è§¸æ§è¨­å‚™å„ªåŒ– === */
        @media (hover: none) and (pointer: coarse) {
            /* ç§»é™¤ hover æ•ˆæœï¼ŒåŠ å¤§è§¸æ§å€ */
            .btn:hover {
                transform: none;
            }

            .step-header:hover {
                background: transparent;
            }

            .strategy-option:hover {
                border-color: rgba(255,255,255,0.15);
                background: transparent;
            }

            /* ç¢ºä¿åˆªé™¤æŒ‰éˆ•å§‹çµ‚å¯è¦‹ */
            .user-option .user-delete {
                opacity: 0.7;
            }

            .history-table .delete-btn {
                opacity: 1;
            }
        }

        /* æ»‘æ¡¿æ¨£å¼ */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        /* åŸºæœ¬è³‡æ–™é¡¯ç¤º */
        .info-display {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--color-primary);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .info-display strong {
            color: var(--color-primary);
        }

        /* éš±è—çš„ input */
        .hidden-input {
            display: none;
        }
    </style>
</head>
<!-- ================================================================
     HTML çµæ§‹å€å¡Š
     ================================================================

     é é¢ä½ˆå±€ï¼š
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    header                           â”‚
       â”‚              (æ¨™é¡Œ + ç”¨æˆ¶é¸æ“‡å™¨)                    â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚   settings-panel â”‚          right-panel             â”‚
       â”‚   âš¡ å¿«é€Ÿè¨˜éŒ„    â”‚   chart-panel (åœ–è¡¨)             â”‚
       â”‚   1. æŠ•è³‡è¦åŠƒ    â”‚   results-panel (å¹´é½¡è©¦ç®—)       â”‚
       â”‚   2. ä½æˆ¿ç­–ç•¥    â”‚   milestones-panel (é‡Œç¨‹ç¢‘)      â”‚
       â”‚   3. é€€ä¼‘è¦åŠƒ    â”‚                                  â”‚
       â”‚   4. ç‰¹æ®Šç¾é‡‘æµ  â”‚                                  â”‚
       â”‚   5. å·¥å…·        â”‚                                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     è³‡æ–™æµå‘ï¼š
       Sheet â†’ loadFromSheet() â†’ state â†’ updateHistorySummary() â†’ UI
       UI â†’ syncToSheet() â†’ Sheet
     ================================================================ -->
<body>
    <!-- ===== HEADER: æ¨™é¡Œèˆ‡ç”¨æˆ¶é¸æ“‡ ===== -->
    <div class="header">
        <h1>ğŸ’° æŠ•è³‡è¦åŠƒèˆ‡ç¸¾æ•ˆè¿½è¹¤å™¨</h1>
        <div class="subtitle">è¿½è¹¤æ­·å²ç¸¾æ•ˆï¼Œè¦åŠƒè²¡å‹™æœªä¾†</div>
        <!-- ç”¨æˆ¶è³‡è¨Šæ‘˜è¦ï¼ˆç”Ÿæ—¥ã€å¹´é½¡ã€è³‡ç”¢ï¼‰ -->
        <div class="user-info-summary" id="userInfoSummary">
            <span>ğŸ“… <span id="headerBirthDate">--</span></span>
            <span class="separator">â”‚</span>
            <span>ğŸ‚ <strong id="headerAge">--</strong> æ­²</span>
            <span class="separator">â”‚</span>
            <span>ğŸ’° <strong id="headerAsset">--</strong> è¬</span>
        </div>
        <!-- ç”¨æˆ¶é¸æ“‡å™¨ -->
        <div class="user-selector-wrapper">
            <div class="user-selector" id="userSelector">
                <!-- ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <div class="container">
        <!-- å·¦å´è¨­å®šå€ -->
        <div class="settings-panel">

            <!-- ===== âš¡ å¿«é€Ÿè¨˜éŒ„ =====
                 ç”¨é€”ï¼šè¨˜éŒ„æŸæ™‚é–“é»çš„ã€Œç´¯è¨ˆæˆæœ¬ã€èˆ‡ã€Œç•¶å‰è³‡ç”¢ã€

                 âš ï¸ é™åˆ¶ï¼š
                 - åªè¨˜éŒ„å¿«ç…§ï¼Œä¸è¨˜éŒ„æ¯ç­†æŠ•å…¥çš„æ™‚é–“
                 - å› æ­¤ç„¡æ³•è¨ˆç®—ç²¾ç¢ºçš„æ™‚é–“åŠ æ¬Šå ±é…¬ï¼ˆXIRRï¼‰
                 - é©åˆï¼šå®šæœŸè¨˜éŒ„è³‡ç”¢ç‹€æ…‹ï¼ˆå¦‚æ¯æœˆåº•ï¼‰
                 - ä¸é©åˆï¼šéœ€è¦ç²¾ç¢ºç¸¾æ•ˆè¨ˆç®—çš„æƒ…æ³

                 å¦‚éœ€ç²¾ç¢º IRRï¼šéœ€è¨˜éŒ„æ¯ç­†å®šæœŸå®šé¡çš„æŠ•å…¥æ—¥æœŸ
            -->
            <div class="step step-quick">
                <div class="step-header" onclick="toggleStep(this)">
                    <div class="step-number">âš¡</div>
                    <div class="step-title">å¿«é€Ÿè¨˜éŒ„</div>
                    <div class="step-toggle">â–¼</div>
                </div>
                <div class="step-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>æ—¥æœŸ</label>
                            <input type="date" id="quickRecordDate">
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <input type="text" id="quickRecordNote" placeholder="é¸å¡«">
                        </div>
                        <div class="form-group">
                            <label>æœ¬é‡‘ï¼ˆè¬ï¼‰</label>
                            <input type="number" id="quickRecordCost" step="0.1" placeholder="ç´¯è¨ˆæŠ•å…¥">
                        </div>
                        <div class="form-group">
                            <label>è³‡ç”¢ï¼ˆè¬ï¼‰</label>
                            <input type="number" id="quickRecordAsset" step="0.1" placeholder="ç›®å‰å¸‚å€¼">
                        </div>
                    </div>
                    <div class="quick-record-result" id="quickRecordResult"></div>
                    <button class="btn btn-primary" onclick="quickRecordAndSync()" style="width: 100%; margin-top: 8px;">
                        ğŸ“¤ è¨˜éŒ„ä¸¦åŒæ­¥åˆ° Sheet
                    </button>

                    <div id="status" class="status"></div>

                    <!-- ğŸ“Š æ­·å²å›é¡§ -->
                    <div class="history-summary" id="historySummary">
                        <div class="title">ğŸ“Š æ­·å²å›é¡§</div>

                        <!-- ç¸½è¦½ -->
                        <div class="history-overview">
                            <div class="overview-main">
                                <div class="overview-item">
                                    <span class="label">ç¸½æŠ•å…¥</span>
                                    <span class="value" id="historyCost">--</span>
                                </div>
                                <div class="overview-item">
                                    <span class="label">ç›®å‰è³‡ç”¢</span>
                                    <span class="value highlight" id="historyAsset">--</span>
                                </div>
                                <div class="overview-item">
                                    <span class="label">ç¸½ç²åˆ©</span>
                                    <span class="value profit" id="historyProfit">--</span>
                                </div>
                            </div>
                            <div class="overview-sub">
                                <span>æŠ•è³‡æœŸé–“ï¼š<strong id="historyPeriod">--</strong></span>
                            </div>
                        </div>

                        <button class="btn btn-primary apply-btn" onclick="applyHistoryToSimulator()">
                            âœ¨ å¥—ç”¨åˆ°æ¨¡æ“¬å™¨
                        </button>

                        <!-- æ­·å²ç´€éŒ„åˆ—è¡¨ -->
                        <div class="history-list-toggle" onclick="toggleHistoryList()">
                            <span id="historyListToggleText">ğŸ“‹ å±•é–‹è©³ç´°ç´€éŒ„</span>
                            <span id="historyListCount"></span>
                        </div>
                        <div class="history-list-container" id="historyListContainer">
                            <table class="history-table">
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>æˆæœ¬</th>
                                        <th>è³‡ç”¢</th>
                                        <th>å‚™è¨»</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== STEP 1: æŠ•è³‡è¦åŠƒ =====
                 è¨­å®šæ¨¡æ“¬åƒæ•¸ï¼šæ¯æœˆæŠ•å…¥ã€é æœŸå ±é…¬ç‡ã€å¹´é½¡ç­‰
                 ã€Œç›®å‰è³‡ç”¢ã€ç”±æ­·å²ç´€éŒ„è‡ªå‹•å¸¶å…¥ï¼ˆå”¯è®€ï¼‰
            -->
            <div class="step step-basic">
                <div class="step-header" onclick="toggleStep(this)">
                    <div class="step-number">1</div>
                    <div class="step-title">æŠ•è³‡è¦åŠƒ</div>
                    <div class="step-toggle">â–¼</div>
                </div>
                <div class="step-content">
                    <!-- éš±è—çš„ inputï¼Œä¾›ç¨‹å¼å…§éƒ¨ä½¿ç”¨ -->
                    <input type="hidden" id="currentValue" value="192">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>æ¯æœˆæŠ•å…¥ï¼ˆè¬ï¼‰</label>
                            <input type="number" id="monthlyContribution" value="2.5" min="0" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>å¹´åŒ–å ±é…¬ç‡</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="range" id="annualRate" min="4" max="20" value="10" step="0.5" style="flex: 1;">
                                <span id="rateDisplay" style="color: var(--color-primary); font-weight: bold; font-size: 14px; min-width: 40px;">10%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é æ¸¬è‡³å¹´é½¡</label>
                            <input type="number" id="targetAge" value="65" min="35" max="100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== STEP 2: ä½æˆ¿ç­–ç•¥ =====
                 å››ç¨®ç­–ç•¥ï¼šè²·æˆ¿ã€ç§Ÿæˆ¿ã€å…ˆç§Ÿå¾Œè²·ã€è²·ç§Ÿæ¯”è¼ƒ
                 è¨ˆç®—æˆ¿è²¸æœˆä¾›ã€ç¸½åˆ©æ¯ã€æ©Ÿæœƒæˆæœ¬ç­‰
            -->
            <div class="step step-housing collapsed">
                <div class="step-header" onclick="toggleStep(this)">
                    <div class="step-number">2</div>
                    <div class="step-title">ä½æˆ¿ç­–ç•¥</div>
                    <div class="step-toggle">â–¼</div>
                </div>
                <div class="step-content">
                    <div class="strategy-options">
                        <div class="strategy-option" data-strategy="none" onclick="selectStrategy('none')">
                            <div class="icon">ğŸš«</div>
                            <div class="name">ä¸è²·æˆ¿</div>
                            <div class="desc">ç„¡ä½æˆ¿æ”¯å‡º</div>
                        </div>
                        <div class="strategy-option" data-strategy="buy" onclick="selectStrategy('buy')">
                            <div class="icon">ğŸ¡</div>
                            <div class="name">è²·æˆ¿</div>
                            <div class="desc">è¨­å®šè³¼æˆ¿å¹´é½¡</div>
                        </div>
                        <div class="strategy-option" data-strategy="rent" onclick="selectStrategy('rent')">
                            <div class="icon">ğŸ¢</div>
                            <div class="name">çµ‚èº«ç§Ÿæˆ¿</div>
                            <div class="desc">ç§Ÿåˆ°é€€ä¼‘</div>
                        </div>
                        <div class="strategy-option" data-strategy="mixed" onclick="selectStrategy('mixed')">
                            <div class="icon">ğŸ”„</div>
                            <div class="name">å…ˆç§Ÿå¾Œè²·</div>
                            <div class="desc">ç§Ÿå¹¾å¹´å†è²·</div>
                        </div>
                    </div>

                    <!-- è²·æˆ¿è¨­å®š -->
                    <div class="strategy-config" id="config-buy">
                        <h4>ğŸ¡ è²·æˆ¿è¨­å®š</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>è³¼æˆ¿å¹´é½¡</label>
                                <input type="number" id="buyAge" value="38" min="25" max="70">
                            </div>
                            <div class="form-group">
                                <label>æˆ¿å±‹ç¸½åƒ¹ï¼ˆè¬ï¼‰</label>
                                <input type="number" id="housePrice" value="1000" min="0" step="50">
                            </div>
                            <div class="form-group">
                                <label>é ­æœŸæ¬¾ï¼ˆ%ï¼‰</label>
                                <input type="number" id="downPaymentPercent" value="20" min="0" max="100" step="5">
                                <div class="form-hint" id="downPaymentHint">= 200 è¬</div>
                            </div>
                            <div class="form-group">
                                <label>è²¸æ¬¾åˆ©ç‡ï¼ˆ%ï¼‰</label>
                                <input type="number" id="mortgageRate" value="2.0" min="0" max="10" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>è²¸æ¬¾å¹´é™</label>
                                <input type="number" id="mortgageYears" value="30" min="10" max="40">
                            </div>
                            <div class="form-group">
                                <label>æˆ¿åƒ¹å¹´æ¼²ï¼ˆ%ï¼‰</label>
                                <input type="number" id="houseAppreciation" value="2" min="0" max="10" step="0.5">
                            </div>
                        </div>
                        <div class="calc-summary" id="buySummary">
                            <div class="title">ğŸ“Š è¨ˆç®—æ‘˜è¦</div>
                            <div class="item"><span>ğŸ  é è¨ˆè²·æˆ¿</span><span class="value" id="buyAgeDisplay">--</span></div>
                            <div class="item"><span>æœˆä»˜é‡‘é¡</span><span class="value" id="monthlyPaymentDisplay">--</span></div>
                            <div class="item"><span>è²¸æ¬¾ç¸½é¡</span><span class="value" id="loanAmountDisplay">--</span></div>
                            <div class="highlight">
                                <div style="font-size: 12px; color: #888;">ğŸ¯ ç”œèœœé»</div>
                                <div class="big" id="sweetSpotDisplay">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- ç§Ÿæˆ¿è¨­å®š -->
                    <div class="strategy-config" id="config-rent">
                        <h4>ğŸ¢ çµ‚èº«ç§Ÿæˆ¿è¨­å®š</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>æœˆç§Ÿé‡‘ï¼ˆè¬ï¼‰</label>
                                <input type="number" id="rentMonthly" value="2" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>å¹´æ¼²å¹…ï¼ˆ%ï¼‰</label>
                                <input type="number" id="rentIncrease" value="2" min="0" max="10" step="0.5">
                            </div>
                        </div>
                        <div class="calc-summary">
                            <div class="title">ğŸ“Š ç§Ÿé‡‘ä¼°ç®—</div>
                            <div class="item"><span>ç›®å‰æœˆç§Ÿ</span><span class="value" id="currentRentDisplay">--</span></div>
                            <div class="item"><span>é€€ä¼‘æ™‚æœˆç§Ÿ</span><span class="value" id="futureRentDisplay">--</span></div>
                            <div class="item"><span>ç¸½ç§Ÿé‡‘æ”¯å‡º</span><span class="value" id="totalRentDisplay">--</span></div>
                        </div>
                    </div>

                    <!-- å…ˆç§Ÿå¾Œè²·è¨­å®š -->
                    <div class="strategy-config" id="config-mixed">
                        <h4>ğŸ”„ å…ˆç§Ÿå¾Œè²·è¨­å®š</h4>
                        <div class="phase-box">
                            <h5>ğŸ“… ç§Ÿæˆ¿éšæ®µ</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>æœˆç§Ÿé‡‘ï¼ˆè¬ï¼‰</label>
                                    <input type="number" id="mixedRentMonthly" value="2" min="0" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>å¹´æ¼²å¹…ï¼ˆ%ï¼‰</label>
                                    <input type="number" id="mixedRentIncrease" value="2" min="0" max="10" step="0.5">
                                </div>
                            </div>
                        </div>
                        <div class="phase-arrow">â¬‡</div>
                        <div class="phase-box">
                            <h5>ğŸ¡ è²·æˆ¿éšæ®µ</h5>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>è³¼æˆ¿å¹´é½¡</label>
                                    <input type="number" id="mixedBuyAge" value="40" min="25" max="70">
                                </div>
                                <div class="form-group">
                                    <label>æˆ¿å±‹ç¸½åƒ¹ï¼ˆè¬ï¼‰</label>
                                    <input type="number" id="mixedHousePrice" value="1200" min="0" step="50">
                                </div>
                                <div class="form-group">
                                    <label>é ­æœŸæ¬¾ï¼ˆ%ï¼‰</label>
                                    <input type="number" id="mixedDownPayment" value="20" min="0" max="100" step="5">
                                </div>
                                <div class="form-group">
                                    <label>è²¸æ¬¾åˆ©ç‡ï¼ˆ%ï¼‰</label>
                                    <input type="number" id="mixedMortgageRate" value="2.0" min="0" max="10" step="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="calc-summary" id="mixedSummary">
                            <div class="title">ğŸ“Š è¨ˆç®—æ‘˜è¦</div>
                            <div class="item"><span>ç§Ÿé‡‘ç¸½æ”¯å‡º</span><span class="value" id="mixedTotalRentDisplay">--</span></div>
                            <div class="item"><span>æœˆä»˜æˆ¿è²¸</span><span class="value" id="mixedMonthlyPayment">--</span></div>
                        </div>
                    </div>

                    <!-- æ¯”è¼ƒæ¨¡å¼ -->
                    <div class="compare-mode">
                        <h4>âš–ï¸ æ¯”è¼ƒæ¨¡å¼</h4>
                        <div class="compare-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="compareModeToggle" onchange="toggleCompareMode()">
                                <span class="toggle-slider"></span>
                            </label>
                            <label>åŒæ™‚æ¯”è¼ƒå¤šç¨®ç­–ç•¥</label>
                        </div>
                        <div class="compare-options" id="compareOptions">
                            <div class="compare-item">
                                <input type="checkbox" id="compareNone" onchange="updateChart()">
                                <label for="compareNone">ğŸš« ä¸è²·æˆ¿</label>
                            </div>
                            <div class="compare-item">
                                <input type="checkbox" id="compareBuy" onchange="updateChart()">
                                <label for="compareBuy">ğŸ¡ è²·æˆ¿</label>
                            </div>
                            <div class="compare-item">
                                <input type="checkbox" id="compareRent" onchange="updateChart()">
                                <label for="compareRent">ğŸ¢ çµ‚èº«ç§Ÿæˆ¿</label>
                            </div>
                            <div class="compare-item">
                                <input type="checkbox" id="compareMixed" onchange="updateChart()">
                                <label for="compareMixed">ğŸ”„ å…ˆç§Ÿå¾Œè²·</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== STEP 3: é€€ä¼‘è¦åŠƒ =====
                 è¨­å®šé€€ä¼‘å¹´é½¡ã€é ä¼°å£½å‘½ã€æ¯æœˆé–‹éŠ·
                 è¨ˆç®—é€€ä¼‘æ‰€éœ€è³‡é‡‘ã€4% æ³•å‰‡é©—è­‰
            -->
            <div class="step step-retire collapsed">
                <div class="step-header" onclick="toggleStep(this)">
                    <div class="step-number">3</div>
                    <div class="step-title">é€€ä¼‘è¦åŠƒ</div>
                    <div class="step-toggle">â–¼</div>
                </div>
                <div class="step-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>é€€ä¼‘å¹´é½¡</label>
                            <input type="number" id="retireAge" value="55" min="40" max="70">
                        </div>
                        <div class="form-group">
                            <label>é ä¼°å£½å‘½</label>
                            <input type="number" id="lifeExpectancy" value="85" min="60" max="100">
                        </div>
                        <div class="form-group">
                            <label>ç›®å‰æ¯æœˆé–‹éŠ·ï¼ˆè¬ï¼‰</label>
                            <input type="number" id="currentExpense" value="3" min="0.5" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>é€šè†¨ç‡ï¼ˆ%ï¼‰</label>
                            <input type="number" id="expenseInflation" value="2" min="0" max="10" step="0.5">
                        </div>
                    </div>

                    <!-- åˆ†éš”ç·š -->
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0; padding-top: 15px;">
                        <div style="font-size: 14px; color: var(--color-text-muted); margin-bottom: 10px; text-align: center;">ğŸ“Š é æ¸¬çµæœ</div>
                    </div>

                    <!-- é€€ä¼‘æ™‚é ä¼°è³‡ç”¢ï¼ˆä¸»è¦é¡¯ç¤ºï¼‰ -->
                    <div style="background: rgba(0, 212, 255, 0.15); border: 1px solid var(--color-primary); border-radius: 10px; padding: 12px; margin-bottom: 10px; text-align: center;">
                        <div style="font-size: 12px; color: var(--color-text-muted);">
                            é€€ä¼‘æ™‚é ä¼°è³‡ç”¢ï¼ˆ<span id="retireAgeDisplay2">55</span> æ­²ï¼‰
                        </div>
                        <div style="font-size: 28px; color: var(--color-primary); font-weight: bold;" id="projectedRetireAsset">--</div>
                        <div style="font-size: 12px; color: var(--color-text-muted); margin-top: 4px;">
                            é€€ä¼‘å¾Œéœ€æ”¯æ’ <span id="retirePeriodDisplay">--</span> å¹´ï¼ˆæœˆé–‹éŠ· <span id="retireExpenseDisplay">--</span>ï¼‰
                        </div>
                    </div>

                    <!-- 4% æ³•å‰‡ èˆ‡ æ¯æœˆå¯èŠ± -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="background: rgba(46, 204, 113, 0.15); border: 1px solid #2ecc71; border-radius: 8px; padding: 10px;">
                            <div style="font-size: 12px; color: #2ecc71; font-weight: bold;">ğŸ›¡ï¸ 4% æ³•å‰‡</div>
                            <div style="font-size: 16px; color: #2ecc71; font-weight: bold; margin: 4px 0;" id="safeRuleStatus">--</div>
                            <div style="font-size: 12px; color: #2ecc71; opacity: 0.9;">
                                ç›®æ¨™ <span id="safeAssetDisplay">--</span>
                            </div>
                        </div>
                        <div style="background: rgba(241, 196, 15, 0.15); border: 1px solid #f39c12; border-radius: 8px; padding: 10px;">
                            <div style="font-size: 12px; color: #f39c12; font-weight: bold;">ğŸ“ èŠ±åˆ° <span id="lifeDisplay">85</span> æ­²</div>
                            <div style="font-size: 16px; color: #f39c12; font-weight: bold; margin: 4px 0;">
                                æœˆèŠ± <span id="exactMonthlyDisplay">--</span>
                            </div>
                            <div style="font-size: 12px; color: #f39c12; opacity: 0.9;">
                                å…± <span id="retirePeriodDisplay2">--</span> å¹´
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                            <input type="checkbox" id="enableRetirement" onchange="updateChart()" style="width: 16px; height: 16px;">
                            å•Ÿç”¨é€€ä¼‘è¦åŠƒ
                        </label>
                    </div>
                </div>
            </div>

            <!-- ===== STEP 4: ç‰¹æ®Šç¾é‡‘æµ =====
                 æ–°å¢ä¸€æ¬¡æ€§æ”¶å…¥/æ”¯å‡ºäº‹ä»¶
                 ä¾‹å¦‚ï¼šå¹´çµ‚çé‡‘ã€æ—…éŠæ”¯å‡ºã€å­å¥³æ•™è‚²è²»
            -->
            <div class="step step-events collapsed">
                <div class="step-header" onclick="toggleStep(this)">
                    <div class="step-number">4</div>
                    <div class="step-title">ç‰¹æ®Šç¾é‡‘æµ</div>
                    <div class="step-toggle">â–¼</div>
                </div>
                <div class="step-content">
                    <!-- é¡å‹é¸æ“‡ -->
                    <div class="event-type-toggle">
                        <button class="type-btn active" data-type="income" onclick="setEventType('income')">
                            ğŸ’° é¡å¤–æŠ•å…¥
                        </button>
                        <button class="type-btn" data-type="expense" onclick="setEventType('expense')">
                            ğŸ’¸ ä¸€æ¬¡æ€§æ”¯å‡º
                        </button>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>å¹´é½¡</label>
                            <input type="number" id="eventAge" value="31" min="25" max="80">
                        </div>
                        <div class="form-group">
                            <label id="eventAmountLabel">é‡‘é¡ï¼ˆè¬ï¼‰</label>
                            <input type="number" id="eventAmount" value="10" min="0">
                        </div>
                        <div class="form-group full-width">
                            <label>èªªæ˜</label>
                            <input type="text" id="eventDesc" value="å¹´çµ‚çé‡‘">
                        </div>
                    </div>
                    <button class="tool-btn" onclick="addEvent()">â• æ–°å¢äº‹ä»¶</button>

                    <!-- å¿«é€ŸæŒ‰éˆ•ï¼šæ”¶å…¥ -->
                    <div class="quick-btns" id="incomeQuickBtns">
                        <span class="quick-label">ğŸ’° æ”¶å…¥ï¼š</span>
                        <button class="quick-btn income" onclick="quickAddIncome(31, 10, 'å¹´çµ‚çé‡‘')">å¹´çµ‚çé‡‘</button>
                        <button class="quick-btn income" onclick="quickAddIncome(35, 50, 'ç¸¾æ•ˆçé‡‘')">ç¸¾æ•ˆçé‡‘</button>
                        <button class="quick-btn income" onclick="quickAddIncome(40, 100, 'è³£è‚¡ç²åˆ©')">è³£è‚¡ç²åˆ©</button>
                    </div>

                    <!-- å¿«é€ŸæŒ‰éˆ•ï¼šæ”¯å‡º -->
                    <div class="quick-btns" id="expenseQuickBtns">
                        <span class="quick-label">ğŸ’¸ æ”¯å‡ºï¼š</span>
                        <button class="quick-btn expense" onclick="quickAddExpense(35, 50, 'çµå©š')">çµå©š</button>
                        <button class="quick-btn expense" onclick="quickAddExpense(40, 100, 'è³¼è»Š')">è³¼è»Š</button>
                        <button class="quick-btn expense" onclick="quickAddExpense(36, 100, 'å°å­©å‡ºç”Ÿ')">å°å­©</button>
                    </div>

                    <div class="event-list" id="eventList"></div>

                    <!-- åŒæ­¥ç¾é‡‘æµæŒ‰éˆ• -->
                    <div class="cashflow-sync-section" id="cashflowSyncSection" style="display: none;">
                        <div style="background: rgba(241, 196, 15, 0.1); border: 1px solid var(--color-warning); border-radius: 8px; padding: 10px; margin-top: 10px;">
                            <div style="font-size: 12px; color: var(--color-warning); margin-bottom: 8px;">
                                âš ï¸ ç¾é‡‘æµæœ‰è®Šæ›´ï¼Œå°šæœªåŒæ­¥åˆ° Sheet
                            </div>
                            <button class="btn btn-primary" onclick="syncCashflowToSheet()" style="width: 100%; font-size: 13px;">
                                ğŸ”„ åŒæ­¥ç¾é‡‘æµåˆ° Sheet
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== STEP 5: è¨­å®šèˆ‡å·¥å…· =====
                 Google Sheet é€£ç·šè¨­å®šï¼ˆSheet IDã€Apps Script URLï¼‰
                 åŒæ­¥æŒ‰éˆ•ã€é€£ç·šæ¸¬è©¦
            -->
            <div class="step step-tools collapsed">
                <div class="step-header" onclick="toggleStep(this)">
                    <div class="step-number">âš™ï¸</div>
                    <div class="step-title">è¨­å®šèˆ‡å·¥å…·</div>
                    <div class="step-toggle">â–¼</div>
                </div>
                <div class="step-content">
                    <!-- ğŸ”— Sheet é€£æ¥è¨­å®š -->
                    <div class="tool-section">
                        <h4>ğŸ”— Sheet é€£æ¥è¨­å®š</h4>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label>Apps Script URL <span id="connectionStatus" style="font-size: 11px;"></span></label>
                            <input type="text" id="appsScriptUrl" placeholder="è²¼ä¸Šéƒ¨ç½²å¾Œçš„ç¶²å€" style="font-size: 13px;">
                        </div>
                        <button class="btn btn-secondary" onclick="testConnection()" id="testConnBtn" style="width: 100%; margin-bottom: 8px;">
                            ğŸ” æ¸¬è©¦é€£ç·š
                        </button>
                        <button class="btn btn-secondary" onclick="copyShareUrl()" style="width: 100%; margin-bottom: 8px;">
                            ğŸ“± è¤‡è£½æ‰‹æ©Ÿé€£çµ
                        </button>

                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-size: 12px; color: var(--color-text-muted);">
                                ğŸ“¥ å¾ Sheet è®€å–è¨­å®šï¼ˆé€²éšï¼‰
                            </summary>
                            <div style="margin-top: 8px;">
                                <div class="form-group">
                                    <label>Sheet ç¶²å€æˆ– ID</label>
                                    <input type="text" id="sheetId" placeholder="è²¼ä¸Šå®Œæ•´ç¶²å€æˆ– ID" oninput="extractSheetId(this)" style="font-size: 13px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                                    <button class="btn btn-secondary" onclick="copyTemplate()">ğŸ“‹ è¤‡è£½ç¯„æœ¬</button>
                                    <button class="btn btn-primary" onclick="loadSheetData()" id="loadBtn">ğŸ“¥ è®€å–</button>
                                </div>
                            </div>
                        </details>

                        <details style="margin-top: 10px; font-size: 11px;">
                            <summary style="cursor: pointer; color: var(--color-text-muted);">
                                ğŸ“– é¦–æ¬¡è¨­å®šèªªæ˜
                            </summary>
                            <div style="margin-top: 8px; line-height: 1.6; color: var(--color-text-muted); background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <strong>è¨­å®š Apps Scriptï¼ˆå¯«å…¥ç”¨ï¼‰ï¼š</strong><br>
                                1. é–‹å•Ÿ Google Sheet â†’ æ“´å……åŠŸèƒ½ â†’ Apps Script<br>
                                2. è²¼ä¸Š SheetSync.gs ç¨‹å¼ç¢¼<br>
                                3. éƒ¨ç½² â†’ æ–°å¢éƒ¨ç½² â†’ ç¶²é æ‡‰ç”¨ç¨‹å¼<br>
                                4. å­˜å–æ¬Šé¸ã€Œæ‰€æœ‰äººã€â†’ éƒ¨ç½²<br>
                                5. è¤‡è£½ç¶²å€è²¼åˆ°ä¸Šæ–¹<br><br>
                                <strong>è®€å–è¨­å®šï¼ˆå¯é¸ï¼‰ï¼š</strong><br>
                                è‹¥è¦å¾ Sheet è®€å–ï¼Œéœ€è¨­å®šç‚ºã€Œä»»ä½•äººéƒ½å¯æª¢è¦–ã€
                            </div>
                        </details>
                    </div>

                    <!-- é€šè†¨è¨ˆç®— -->
                    <div class="tool-section">
                        <h4>ğŸ“ˆ é€šè†¨è¨ˆç®—æ©Ÿ</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ç¾åœ¨é‡‘é¡ï¼ˆè¬ï¼‰</label>
                                <input type="number" id="inflationAmount" value="100">
                            </div>
                            <div class="form-group">
                                <label>å¹´æ•¸</label>
                                <input type="number" id="inflationYears" value="20">
                            </div>
                            <div class="form-group">
                                <label>é€šè†¨ç‡ï¼ˆ%ï¼‰</label>
                                <input type="number" id="inflationRate" value="2" step="0.5">
                            </div>
                        </div>
                        <button class="tool-btn" onclick="calculateInflation()">è¨ˆç®—</button>
                        <div class="tool-result" id="inflationResult"></div>
                    </div>

                    <!-- IRR è¨ˆç®— -->
                    <div class="tool-section">
                        <h4>ğŸ“Š IRR è¨ˆç®—æ©Ÿ</h4>
                        <button class="btn btn-secondary" onclick="autoFillIRR()" style="width: 100%; margin-bottom: 10px; font-size: 12px;">
                            ğŸ”„ å¾æ­·å²ç´€éŒ„è‡ªå‹•å¸¶å…¥
                        </button>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>æ¯æœˆæŠ•å…¥ï¼ˆè¬ï¼‰</label>
                                <input type="number" id="irrMonthly" value="2.5">
                            </div>
                            <div class="form-group">
                                <label>æŠ•è³‡æœˆæ•¸</label>
                                <input type="number" id="irrMonths" value="68">
                            </div>
                            <div class="form-group full-width">
                                <label>ç›®å‰è³‡ç”¢ï¼ˆè¬ï¼‰</label>
                                <input type="number" id="irrAsset" value="192">
                            </div>
                        </div>
                        <button class="tool-btn" onclick="calculateIRR()">è¨ˆç®— IRR</button>
                        <div class="tool-result" id="irrResult"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== å³å´é¢æ¿ =====
             åŒ…å«å…©å€‹ä¸»è¦å€å¡Šï¼š
             1. chart-panel: ä¸»åœ–è¡¨ï¼ˆæ­·å²è»Œè·¡ + é æ¸¬ç·šï¼‰
             2. stats-panel: æ•´åˆé‡Œç¨‹ç¢‘ + é—œéµå¹´é½¡é æ¸¬
        -->
        <div class="right-panel">
            <!-- åœ–è¡¨ï¼šä½¿ç”¨ Chart.js ç¹ªè£½ -->
            <div class="chart-panel">
                <h2>ğŸ“ˆ è³‡ç”¢æˆé•·è»Œè·¡</h2>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- æ•´åˆçµ±è¨ˆå€ï¼šé‡Œç¨‹ç¢‘ + é—œéµå¹´é½¡ -->
            <div class="stats-panel">
                <h3>ğŸ† é‡Œç¨‹ç¢‘èˆ‡é æ¸¬</h3>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
    </div>

    <script>
        /* ================================================================
         * JavaScript å€å¡Š
         * ================================================================
         *
         * çµæ§‹æ¦‚è¦½ï¼š
         *   1. CONFIG          - é…ç½®å¸¸æ•¸ï¼ˆç”¨æˆ¶ã€é‡Œç¨‹ç¢‘ã€é è¨­å€¼ï¼‰
         *   2. state           - å…¨åŸŸç‹€æ…‹ï¼ˆæ­·å²è³‡æ–™ã€äº‹ä»¶ã€åœ–è¡¨å¯¦ä¾‹ï¼‰
         *   3. Utils           - å·¥å…·å‡½æ•¸ï¼ˆæ—¥æœŸè§£æã€æ ¼å¼åŒ–ã€å¹´é½¡è¨ˆç®—ï¼‰
         *   4. Sheet åŒæ­¥      - Google Sheet è®€å¯«ï¼ˆfetchSheet, syncToSheetï¼‰
         *   5. å¿«é€Ÿè¨˜éŒ„        - quickRecordAndSync()
         *   6. æ­·å²å›é¡§        - updateHistorySummary(), renderHistoryList()
         *   7. æŠ•è³‡æ¨¡æ“¬        - calculate() ä¸»è¨ˆç®—é‚è¼¯
         *   8. ä½æˆ¿è¨ˆç®—        - è²·æˆ¿/ç§Ÿæˆ¿/æ¯”è¼ƒçš„è²¡å‹™è¨ˆç®—
         *   9. åœ–è¡¨ç¹ªè£½        - Chart.js åœ–è¡¨æ›´æ–°
         *   10. åˆå§‹åŒ–         - init() é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
         *
         * è³‡æ–™æµï¼š
         *   [Sheet] â†â†’ fetchSheet/syncToSheet â†â†’ [state] â†’ [UI]
         *
         * é‡è¦æé†’ï¼š
         *   - Google Sheet æ˜¯å”¯ä¸€è³‡æ–™ä¾†æº
         *   - localStorage åªå­˜é€£ç·šè¨­å®šï¼ˆSheet IDã€URLï¼‰
         *   - å¿«é€Ÿè¨˜éŒ„åªå­˜å¿«ç…§ï¼Œä¸å­˜æ¯ç­†å®šæœŸå®šé¡æ™‚é–“
         * ================================================================ */

        // ========== 1. é…ç½®å¸¸æ•¸ ==========
        const CONFIG = {
            // å¤šç”¨æˆ¶è¨­å®š
            USERS: {
                'hey': {
                    name: 'Hey',
                    birthDate: new Date(1994, 9, 18),
                    description: '1994/10/18'
                },
                'judy': {
                    name: 'Judy',
                    birthDate: new Date(1995, 6, 18),
                    description: '1995/07/18'
                }
            },

            // é è¨­ç”¨æˆ¶
            DEFAULT_USER: 'hey',

            // é‡Œç¨‹ç¢‘ç›®æ¨™ï¼ˆè¬ï¼‰
            MILESTONES: [100, 200, 300, 500, 1000, 2000, 3000, 5000],

            // é¡¯ç¤ºçš„å¹´é½¡ç¯€é»
            DISPLAY_AGES: [35, 40, 45, 50, 55, 60, 65],

            // é è¨­å€¼
            DEFAULTS: {
                CURRENT_VALUE: 192,
                MONTHLY_CONTRIBUTION: 2.5,
                ANNUAL_RATE: 10,
                TARGET_AGE: 65,
                HOUSE_PRICE: 1000,
                DOWN_PAYMENT_PERCENT: 20,
                MORTGAGE_RATE: 2.0,
                MORTGAGE_YEARS: 30,
                RENT_MONTHLY: 2,
                RETIRE_AGE: 55,
                LIFE_EXPECTANCY: 85
            },

            // åœ–è¡¨é¡è‰²ï¼ˆå°æ‡‰ CSS è®Šæ•¸ï¼‰
            COLORS: {
                primary: '#00d4ff',
                success: '#2ecc71',
                warning: '#f39c12',
                danger: '#e74c3c',
                purple: '#9b59b6',
                muted: '#95a5a6'
            },

            // ç­–ç•¥é…ç½®
            STRATEGIES: {
                none: { name: 'ğŸš« ä¸è²·æˆ¿', color: '#00d4ff' },
                buy: { name: 'ğŸ¡ è²·æˆ¿', color: '#2ecc71' },
                rent: { name: 'ğŸ¢ çµ‚èº«ç§Ÿæˆ¿', color: '#9b59b6' },
                mixed: { name: 'ğŸ”„ å…ˆç§Ÿå¾Œè²·', color: '#f39c12' }
            }
        };

        /* --------------------------------
         * 2. å…¨åŸŸç‹€æ…‹
         * --------------------------------
         * historyData: æŠ•è³‡ç´€éŒ„é™£åˆ— [{date, cost, asset, note}]
         * events: ç‰¹æ®Šç¾é‡‘æµé™£åˆ— [{age, type, amount, desc}]
         * chart: Chart.js å¯¦ä¾‹
         * currentStrategy: ä½æˆ¿ç­–ç•¥ (none/buy/rent/mixed)
         * currentUser: ç•¶å‰ç”¨æˆ¶ key
         * -------------------------------- */
        const state = {
            historyData: [],
            events: [],
            chart: null,
            currentStrategy: 'none',
            historicalIRR: 0,
            currentUser: CONFIG.DEFAULT_USER,
            cashflowChanged: false,  // è¿½è¹¤ç¾é‡‘æµæ˜¯å¦æœ‰è®Šæ›´
            connectionVerified: false  // è¿½è¹¤é€£ç·šæ˜¯å¦å·²é©—è­‰
        };

        /* --------------------------------
         * 3. å·¥å…·å‡½æ•¸
         * --------------------------------
         * debounce()      - é˜²æŠ–å‹•
         * formatMoney()   - æ ¼å¼åŒ–é‡‘é¡
         * getInputValue() - å–å¾—è¼¸å…¥å€¼
         * parseDate()     - æ—¥æœŸè§£æï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
         * getAge()        - è¨ˆç®—å¹´é½¡
         * -------------------------------- */
        const Utils = {
            // é€šç”¨çš„ debounce å‡½æ•¸
            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },

            // æ ¼å¼åŒ–é‡‘é¡é¡¯ç¤º
            formatMoney(amount, decimals = 0) {
                return amount.toFixed(decimals) + ' è¬';
            },

            // å¾è¼¸å…¥æ¡†å–å¾—æ•¸å€¼
            getInputValue(id, defaultValue = 0) {
                return parseFloat(document.getElementById(id)?.value) || defaultValue;
            },

            // è¨­å®šè¼¸å…¥æ¡†æ•¸å€¼
            setInputValue(id, value) {
                const el = document.getElementById(id);
                if (el) el.value = value;
            },

            // æ—¥æœŸè§£æï¼ˆçµ±ä¸€å…¥å£ï¼‰
            parseDate(dateStr) {
                if (!dateStr) return null;

                // Google Sheet Date æ ¼å¼
                if (typeof dateStr === 'string' && dateStr.startsWith('Date(')) {
                    const match = dateStr.match(/Date\((\d+),(\d+),(\d+)\)/);
                    if (match) {
                        return new Date(parseInt(match[1]), parseInt(match[2]), parseInt(match[3]));
                    }
                }

                // æ¨™æº–æ—¥æœŸæ ¼å¼
                const patterns = [
                    /^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/,
                    /^(\d{4})[-\/](\d{1,2})$/,
                ];

                for (const pattern of patterns) {
                    const match = String(dateStr).match(pattern);
                    if (match) {
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]) - 1;
                        const day = match[3] ? parseInt(match[3]) : 1;
                        return new Date(year, month, day);
                    }
                }

                const date = new Date(dateStr);
                return isNaN(date) ? null : date;
            },

            // è¨ˆç®—å¹´é½¡ï¼ˆæ”¯æ´å¤šç”¨æˆ¶ï¼‰
            getAge(date = new Date()) {
                const birthDate = CONFIG.USERS[state.currentUser]?.birthDate || CONFIG.USERS[CONFIG.DEFAULT_USER].birthDate;
                let age = date.getFullYear() - birthDate.getFullYear();
                const monthDiff = date.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && date.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            },

            // å–å¾—ç•¶å‰ç”¨æˆ¶çš„å‡ºç”Ÿæ—¥æœŸ
            getBirthDate() {
                return CONFIG.USERS[state.currentUser]?.birthDate || CONFIG.USERS[CONFIG.DEFAULT_USER].birthDate;
            }
        };

        /* --------------------------------
         * è²¡å‹™è¨ˆç®—å·¥å…·
         * --------------------------------
         * mortgagePayment() - æˆ¿è²¸æœˆä»˜é‡‘ï¼ˆæœ¬æ¯å‡æ”¤ï¼‰
         * calculateIRR()    - IRR è¨ˆç®—ï¼ˆäºŒåˆ†æ³•ï¼‰
         * futureValue()     - è¤‡åˆ©çµ‚å€¼
         * retirementAsset() - é€€ä¼‘æ‰€éœ€è³‡ç”¢ï¼ˆç²¾ç®—ï¼‰
         * totalRent()       - ç§Ÿé‡‘ç¸½æ”¯å‡º
         * -------------------------------- */
        const Calculator = {
            // æˆ¿è²¸æœˆä»˜é‡‘è¨ˆç®—
            mortgagePayment(principal, annualRate, years) {
                if (annualRate === 0) return principal / (years * 12);
                const monthlyRate = annualRate / 12;
                const n = years * 12;
                return principal * monthlyRate * Math.pow(1 + monthlyRate, n) / (Math.pow(1 + monthlyRate, n) - 1);
            },

            // IRR è¨ˆç®—ï¼ˆäºŒåˆ†æ³•ï¼‰
            calculateIRR(monthlyInvest, months, finalAsset) {
                let low = 0, high = 0.1, mid;

                for (let i = 0; i < 100; i++) {
                    mid = (low + high) / 2;
                    const fv = mid === 0
                        ? monthlyInvest * months
                        : monthlyInvest * (Math.pow(1 + mid, months) - 1) / mid;

                    if (Math.abs(fv - finalAsset) < 0.01) break;
                    if (fv < finalAsset) low = mid;
                    else high = mid;
                }

                return (Math.pow(1 + mid, 12) - 1) * 100; // å¹´åŒ–
            },

            // è¤‡åˆ©è¨ˆç®—
            futureValue(present, rate, years) {
                return present * Math.pow(1 + rate, years);
            },

            // é€€ä¼‘æ‰€éœ€è³‡ç”¢ï¼ˆç²¾ç®—æ–¹æ¡ˆï¼‰
            retirementAsset(monthlyExpense, years, investRate, inflation) {
                let total = 0;
                for (let i = 0; i < years; i++) {
                    const yearExpense = monthlyExpense * 12 * Math.pow(1 + inflation, i);
                    total += yearExpense / Math.pow(1 + investRate, i);
                }
                return total;
            },

            // ç§Ÿé‡‘ç¸½æ”¯å‡º
            totalRent(monthlyRent, years, annualIncrease) {
                let total = 0;
                for (let i = 0; i < years; i++) {
                    total += monthlyRent * Math.pow(1 + annualIncrease, i) * 12;
                }
                return total;
            }
        };

        /* --------------------------------
         * 9. åˆå§‹åŒ–
         * --------------------------------
         * é é¢è¼‰å…¥æ™‚åŸ·è¡Œï¼š
         *   1. initUserSelector() - åˆå§‹åŒ–ç”¨æˆ¶é¸æ“‡å™¨
         *   2. initQuickRecord() - åˆå§‹åŒ–å¿«é€Ÿè¨˜éŒ„æ—¥æœŸ
         *   3. initChart() - åˆå§‹åŒ– Chart.js
         *   4. loadSavedData() - è¼‰å…¥é€£ç·šè¨­å®šï¼ˆlocalStorageï¼‰
         *   5. autoLoadFromSheet() - è‡ªå‹•å¾ Sheet è¼‰å…¥è³‡æ–™
         *
         * è³‡æ–™ä¾†æºï¼š
         *   - Google Sheet æ˜¯å”¯ä¸€è³‡æ–™ä¾†æº
         *   - localStorage åªå­˜é€£ç·šè¨­å®š
         *   - URL åƒæ•¸å¯è¦†è“‹è¨­å®šï¼ˆæ–¹ä¾¿è·¨è£ç½®ä½¿ç”¨ï¼‰
         *     ä¾‹å¦‚ï¼š?sheet=SHEET_ID&user=me
         * -------------------------------- */
        window.onload = async function() {
            initUserSelector();
            initQuickRecord();
            updateCurrentAge();
            initChart();
            setupAutoUpdate();
            loadSavedData();

            // è™•ç† URL åƒæ•¸ï¼ˆè¦†è“‹ localStorage è¨­å®šï¼‰
            applyUrlParams();

            selectStrategy('none');
            updateAllCalculations();

            // è‡ªå‹•å¾ Sheet åŒæ­¥è³‡æ–™ï¼ˆå¦‚æœå·²è¨­å®šï¼‰
            await autoLoadFromSheet();
        };

        // è§£æ URL åƒæ•¸ä¸¦å¥—ç”¨è¨­å®š
        // æ”¯æ´åƒæ•¸ï¼š
        //   - sheet: Google Sheet ID
        //   - user: ç”¨æˆ¶ ID (me/judy/æˆ–è‡ªè¨‚)
        function applyUrlParams() {
            const params = new URLSearchParams(window.location.search);

            // Sheet ID
            const sheetParam = params.get('sheet');
            if (sheetParam) {
                Utils.setInputValue('sheetId', sheetParam);
                localStorage.setItem('investmentSheetId', sheetParam);
            }

            // ç”¨æˆ¶é¸æ“‡
            const userParam = params.get('user');
            if (userParam && CONFIG.USERS[userParam]) {
                state.currentUser = userParam;
                localStorage.setItem('currentUser', userParam);
                renderUserSelector();
            }
        }

        // ç”¢ç”Ÿå¯åˆ†äº«çš„ URLï¼ˆå«ç›®å‰è¨­å®šï¼‰
        function generateShareUrl() {
            const sheetId = document.getElementById('sheetId').value.trim();
            if (!sheetId) {
                showStatus('è«‹å…ˆè¨­å®š Sheet ID', 'error');
                return null;
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const params = new URLSearchParams();
            params.set('sheet', sheetId);
            params.set('user', state.currentUser);

            return baseUrl + '?' + params.toString();
        }

        // è¤‡è£½åˆ†äº«é€£çµåˆ°å‰ªè²¼ç°¿
        async function copyShareUrl() {
            const url = generateShareUrl();
            if (!url) return;

            try {
                await navigator.clipboard.writeText(url);
                showStatus('âœ… å·²è¤‡è£½é€£çµï¼åœ¨æ‰‹æ©Ÿç€è¦½å™¨è²¼ä¸Šå³å¯', 'success');
            } catch (err) {
                // é™ç´šæ–¹æ¡ˆï¼šé¡¯ç¤ºé€£çµè®“ç”¨æˆ¶æ‰‹å‹•è¤‡è£½
                prompt('è¤‡è£½æ­¤é€£çµåˆ°æ‰‹æ©Ÿï¼š', url);
            }
        }

        // è‡ªå‹•å¾ Sheet è¼‰å…¥è³‡æ–™ï¼ˆéœé»˜æ¨¡å¼ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤ï¼‰
        // å¾ Sheet è¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼ˆSheet ç‚ºå”¯ä¸€è³‡æ–™ä¾†æºï¼‰
        async function autoLoadFromSheet() {
            const sheetId = document.getElementById('sheetId').value.trim();
            if (!sheetId) {
                showStatus('âš ï¸ è«‹è¨­å®š Sheet ID ä»¥è¼‰å…¥è³‡æ–™', 'warning');
                return;
            }

            const userSheetName = getUserSheetName();
            showStatus(`æ­£åœ¨å¾ Sheet è¼‰å…¥ã€Œ${userSheetName}ã€çš„è³‡æ–™...`, 'loading');

            try {
                const response = await fetchSheet(sheetId, userSheetName);

                if (!response.table?.rows?.length) {
                    showStatus(`ã€Œ${userSheetName}ã€åˆ†é å°šç„¡è³‡æ–™`, 'warning');
                    return;
                }

                // å®Œå…¨å¾ Sheet è¼‰å…¥ï¼ˆä¸åˆä½µæœ¬åœ°è³‡æ–™ï¼‰
                parseUserSheet(response.table);

                const summary = [];
                if (state.historyData.length > 0) summary.push(`${state.historyData.length} ç­†ç´€éŒ„`);
                if (state.events.length > 0) summary.push(`${state.events.length} ç­†ç¾é‡‘æµ`);

                if (summary.length > 0) {
                    showStatus(`âœ… å·²å¾ Sheet è¼‰å…¥ï¼š${summary.join('ã€')}`, 'success');
                    onHistoryDataLoaded();
                } else {
                    showStatus('âœ… å·²è¼‰å…¥è¨­å®š', 'success');
                }

            } catch (error) {
                console.error('Load from Sheet failed:', error.message);
                showStatus('âŒ ç„¡æ³•å¾ Sheet è¼‰å…¥ï¼š' + error.message, 'error');
            }
        }

        // å·²ç§»é™¤åˆä½µé‚è¼¯ï¼ˆä¸å†éœ€è¦ï¼Œå› ç‚º Sheet æ˜¯å”¯ä¸€è³‡æ–™ä¾†æºï¼‰
        // mergeHistoryData å’Œ mergeEventsData å‡½æ•¸å·²åˆªé™¤

        // ä¿ç•™ç©ºå‡½æ•¸ä»¥é˜²èˆŠç¨‹å¼ç¢¼å‘¼å«
        function mergeHistoryData(local, sheet) {
            return sheet; // ç›´æ¥è¿”å› Sheet è³‡æ–™
        }

        // åˆå§‹åŒ–ç”¨æˆ¶é¸æ“‡å™¨
        function initUserSelector() {
            // è¼‰å…¥è‡ªè¨‚ç”¨æˆ¶ï¼ˆå¾ localStorageï¼‰
            loadCustomUsers();

            const container = document.getElementById('userSelector');
            const savedUser = localStorage.getItem('currentUser') || CONFIG.DEFAULT_USER;

            // ç¢ºä¿ç”¨æˆ¶å­˜åœ¨ï¼Œå¦å‰‡å›åˆ°é è¨­
            if (!CONFIG.USERS[savedUser]) {
                state.currentUser = CONFIG.DEFAULT_USER;
            } else {
                state.currentUser = savedUser;
            }

            renderUserSelector();
        }

        // æ¸²æŸ“ç”¨æˆ¶é¸æ“‡å™¨
        function renderUserSelector() {
            const container = document.getElementById('userSelector');

            const usersHtml = Object.entries(CONFIG.USERS).map(([id, user]) => `
                <div class="user-option ${id === state.currentUser ? 'selected' : ''}" data-user="${id}" onclick="selectUser('${id}')">
                    <div class="user-name">${user.name}</div>
                    <div class="user-info">${user.description}</div>
                    ${user.custom ? `<span class="user-delete" onclick="event.stopPropagation(); deleteUser('${id}')" title="åˆªé™¤">Ã—</span>` : ''}
                </div>
            `).join('');

            const addBtnHtml = `
                <div class="user-option user-add" onclick="showAddUserDialog()">
                    <div class="user-name">+ æ–°å¢</div>
                </div>
            `;

            container.innerHTML = usersHtml + addBtnHtml;
        }

        // è¼‰å…¥è‡ªè¨‚ç”¨æˆ¶
        function loadCustomUsers() {
            const saved = localStorage.getItem('customUsers');
            if (saved) {
                try {
                    const customUsers = JSON.parse(saved);
                    Object.entries(customUsers).forEach(([id, user]) => {
                        CONFIG.USERS[id] = {
                            ...user,
                            birthDate: new Date(user.birthDate),
                            custom: true
                        };
                    });
                } catch (e) {
                    console.warn('è¼‰å…¥è‡ªè¨‚ç”¨æˆ¶å¤±æ•—:', e);
                }
            }
        }

        // å„²å­˜è‡ªè¨‚ç”¨æˆ¶
        function saveCustomUsers() {
            const customUsers = {};
            Object.entries(CONFIG.USERS).forEach(([id, user]) => {
                if (user.custom) {
                    customUsers[id] = {
                        name: user.name,
                        birthDate: user.birthDate.toISOString(),
                        description: user.description,
                        custom: true
                    };
                }
            });
            localStorage.setItem('customUsers', JSON.stringify(customUsers));
        }

        // é¡¯ç¤ºæ–°å¢ç”¨æˆ¶å°è©±æ¡†
        function showAddUserDialog() {
            const name = prompt('è«‹è¼¸å…¥ç”¨æˆ¶åç¨±ï¼š');
            if (!name || !name.trim()) return;

            const birthStr = prompt('è«‹è¼¸å…¥ç”Ÿæ—¥ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰ï¼š', '1990-01-01');
            if (!birthStr) return;

            const birthDate = new Date(birthStr);
            if (isNaN(birthDate.getTime())) {
                showStatus('æ—¥æœŸæ ¼å¼éŒ¯èª¤', 'error');
                return;
            }

            // ç”Ÿæˆ ID
            const id = name.trim().toLowerCase().replace(/\s+/g, '_') + '_' + Date.now().toString(36);

            // æ–°å¢åˆ° CONFIG
            CONFIG.USERS[id] = {
                name: name.trim(),
                birthDate: birthDate,
                description: birthStr,
                custom: true
            };

            // å„²å­˜ä¸¦æ›´æ–° UI
            saveCustomUsers();
            renderUserSelector();
            selectUser(id);
            showStatus(`å·²æ–°å¢ç”¨æˆ¶ã€Œ${name.trim()}ã€`, 'success');
        }

        // åˆªé™¤ç”¨æˆ¶
        function deleteUser(userId) {
            const user = CONFIG.USERS[userId];
            if (!user || !user.custom) return;

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${user.name}ã€å—ï¼Ÿ\nè©²ç”¨æˆ¶çš„æ‰€æœ‰è³‡æ–™å°‡è¢«æ¸…é™¤ã€‚`)) return;

            // åˆªé™¤è©²ç”¨æˆ¶çš„ localStorage è³‡æ–™
            localStorage.removeItem(`investmentData_${userId}`);

            // å¾ CONFIG ç§»é™¤
            delete CONFIG.USERS[userId];

            // å„²å­˜
            saveCustomUsers();

            // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰ç”¨æˆ¶ï¼Œåˆ‡æ›å›é è¨­
            if (state.currentUser === userId) {
                state.currentUser = CONFIG.DEFAULT_USER;
                localStorage.setItem('currentUser', CONFIG.DEFAULT_USER);
                loadSavedData();
            }

            renderUserSelector();
            showStatus(`å·²åˆªé™¤ç”¨æˆ¶ã€Œ${user.name}ã€`, 'success');
        }

        // é¸æ“‡ç”¨æˆ¶
        async function selectUser(userId) {
            if (userId === state.currentUser) return;  // ç›¸åŒç”¨æˆ¶ï¼Œä¸è™•ç†

            // 1. å…ˆå„²å­˜ç•¶å‰ç”¨æˆ¶çš„è³‡æ–™
            saveAllData();

            // 2. åˆ‡æ›ç”¨æˆ¶
            const previousUser = state.currentUser;
            state.currentUser = userId;
            localStorage.setItem('currentUser', userId);

            // 3. é‡ç½® stateï¼ˆé¿å…è³‡æ–™æ··æ·†ï¼‰
            state.historyData = [];
            state.events = [];
            state.currentStrategy = 'none';
            state.historicalIRR = 0;
            state.cashflowChanged = false;

            // 4. è¼‰å…¥é€£ç·šè¨­å®š
            loadSavedData();

            // 5. æ›´æ–° UI
            document.querySelectorAll('.user-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.user === userId);
            });

            // 6. éš±è—æ­·å²æ‘˜è¦ï¼ˆç­‰å¾…è¼‰å…¥å¾Œé¡¯ç¤ºï¼‰
            document.getElementById('historySummary').classList.remove('active');
            document.getElementById('cashflowSyncSection').style.display = 'none';

            // 7. é‡æ–°æ•´ç†äº‹ä»¶åˆ—è¡¨
            refreshEventList();

            // 8. æ›´æ–° Headerï¼ˆç”Ÿæ—¥ã€å¹´é½¡ï¼‰
            updateCurrentAge();

            // 9. é‡ç½® Header è³‡ç”¢é¡¯ç¤ºï¼ˆç­‰å¾… Sheet è¼‰å…¥å¾Œæ›´æ–°ï¼‰
            updateHeaderAsset(null);

            selectStrategy(state.currentStrategy);
            updateAllCalculations();

            showStatus(`æ­£åœ¨è¼‰å…¥ ${CONFIG.USERS[userId].name} çš„è³‡æ–™...`, 'success');

            // 10. å¾ Sheet é‡æ–°è¼‰å…¥æ–°ç”¨æˆ¶çš„è³‡æ–™
            await autoLoadFromSheet();
        }

        // åˆå§‹åŒ–å¿«é€Ÿè¨˜éŒ„
        function initQuickRecord() {
            // è¨­å®šä»Šå¤©æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quickRecordDate').value = today;

            // è¼¸å…¥æ™‚è¨ˆç®—å ±é…¬
            ['quickRecordCost', 'quickRecordAsset'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateQuickRecordResult);
            });
        }

        // æ›´æ–°å¿«é€Ÿè¨˜éŒ„çš„çµæœé¡¯ç¤º
        function updateQuickRecordResult() {
            const cost = parseFloat(document.getElementById('quickRecordCost').value) || 0;
            const asset = parseFloat(document.getElementById('quickRecordAsset').value) || 0;
            const resultEl = document.getElementById('quickRecordResult');

            if (cost > 0 && asset > 0) {
                const profit = asset - cost;
                const returnRate = ((profit / cost) * 100).toFixed(1);
                const profitClass = profit >= 0 ? 'positive' : 'negative';
                const sign = profit >= 0 ? '+' : '';

                resultEl.innerHTML = `
                    å ±é…¬ï¼š<span class="profit ${profitClass}">${sign}${profit.toFixed(1)} è¬ (${sign}${returnRate}%)</span>
                `;
                resultEl.classList.add('active');
            } else {
                resultEl.classList.remove('active');
            }
        }

        function updateCurrentAge() {
            const age = Utils.getAge();
            const birthDate = Utils.getBirthDate();
            const birthStr = `${birthDate.getFullYear()}/${birthDate.getMonth() + 1}/${birthDate.getDate()}`;

            // æ›´æ–° Header é¡¯ç¤º
            document.getElementById('headerBirthDate').textContent = birthStr;
            document.getElementById('headerAge').textContent = age;
            return age;
        }

        // æ›´æ–° Header è³‡ç”¢é¡¯ç¤º
        function updateHeaderAsset(asset) {
            document.getElementById('headerAsset').textContent = asset ? asset.toFixed(0) : '--';
        }

        function getCurrentAge() {
            return Utils.getAge();
        }

        // ========== è‡ªå‹•æ›´æ–°è¨­å®š ==========
        function setupAutoUpdate() {
            const debouncedUpdate = Utils.debounce(updateAllCalculations, 300);
            const debouncedSave = Utils.debounce(saveAllData, 1000);  // 1 ç§’å¾Œè‡ªå‹•å„²å­˜

            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', () => {
                    debouncedUpdate();
                    debouncedSave();
                });
                input.addEventListener('input', () => {
                    debouncedUpdate();
                    debouncedSave();
                });
            });

            // å ±é…¬ç‡æ»‘æ¡¿å³æ™‚é¡¯ç¤º
            document.getElementById('annualRate').addEventListener('input', function() {
                document.getElementById('rateDisplay').textContent = this.value + '%';
            });
        }

        function updateAllCalculations() {
            updateBuyCalculations();
            updateRentCalculations();
            updateMixedCalculations();
            updateRetireCalculations();
            updateChart();
        }

        // ========== æ­¥é©Ÿå±•é–‹/æ”¶åˆ ==========
        function toggleStep(header) {
            const step = header.parentElement;
            step.classList.toggle('collapsed');
        }

        /* --------------------------------
         * 8. ä½æˆ¿ç­–ç•¥è¨ˆç®—
         * --------------------------------
         * å››ç¨®ç­–ç•¥ï¼š
         *   none  - ä¸è²·æˆ¿ï¼ˆç´”æŠ•è³‡ï¼‰
         *   buy   - è²·æˆ¿ï¼ˆæˆ¿è²¸è¨ˆç®—ï¼‰
         *   rent  - çµ‚èº«ç§Ÿæˆ¿ï¼ˆç§Ÿé‡‘ç´¯è¨ˆï¼‰
         *   mixed - å…ˆç§Ÿå¾Œè²·ï¼ˆå…©éšæ®µï¼‰
         *
         * ä¸»è¦è¨ˆç®—ï¼š
         *   - æˆ¿è²¸æœˆä¾›ï¼ˆæœ¬æ¯å‡æ”¤ï¼‰
         *   - ç§Ÿé‡‘ç´¯è¨ˆï¼ˆå«æ¼²å¹…ï¼‰
         *   - æ©Ÿæœƒæˆæœ¬ï¼ˆæŠ•è³‡å ±é…¬ vs æˆ¿è²¸åˆ©æ¯ï¼‰
         *   - è²·æˆ¿ç”œèœœé»ï¼ˆç­‰æ•ˆæŠ•è³‡æœ¬é‡‘ï¼‰
         * -------------------------------- */
        function selectStrategy(strategy) {
            state.currentStrategy = strategy;

            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.strategy-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.strategy === strategy);
            });

            // é¡¯ç¤ºå°æ‡‰è¨­å®š
            document.querySelectorAll('.strategy-config').forEach(config => {
                config.classList.remove('active');
            });

            if (strategy !== 'none') {
                document.getElementById(`config-${strategy}`)?.classList.add('active');
            }

            updateAllCalculations();
        }

        // ========== æ¯”è¼ƒæ¨¡å¼ ==========
        function toggleCompareMode() {
            const enabled = document.getElementById('compareModeToggle').checked;
            document.getElementById('compareOptions').classList.toggle('active', enabled);
            updateChart();
        }

        // ========== è²·æˆ¿è¨ˆç®— ==========
        function updateBuyCalculations() {
            const buyAge = Utils.getInputValue('buyAge', 38);
            const housePrice = Utils.getInputValue('housePrice');
            const downPaymentPercent = Utils.getInputValue('downPaymentPercent') / 100;
            const mortgageRate = Utils.getInputValue('mortgageRate') / 100;
            const mortgageYears = Utils.getInputValue('mortgageYears', 30);

            const downPayment = housePrice * downPaymentPercent;
            const loanAmount = housePrice - downPayment;
            const monthlyPayment = Calculator.mortgagePayment(loanAmount, mortgageRate, mortgageYears);

            document.getElementById('buyAgeDisplay').textContent = buyAge + ' æ­²';
            document.getElementById('downPaymentHint').textContent = `= ${downPayment.toFixed(0)} è¬`;
            document.getElementById('monthlyPaymentDisplay').textContent = monthlyPayment.toFixed(2) + ' è¬/æœˆ';
            document.getElementById('loanAmountDisplay').textContent = loanAmount.toFixed(0) + ' è¬';

            // ç”œèœœé»ï¼šå¹´åº¦æˆ¿è²¸æ”¯å‡º / æŠ•è³‡å ±é…¬ç‡ = ç­‰æ•ˆæŠ•è³‡æœ¬é‡‘
            const annualRate = Utils.getInputValue('annualRate') / 100;
            const sweetSpot = annualRate > 0 ? (monthlyPayment * 12 / annualRate) : 0;
            document.getElementById('sweetSpotDisplay').textContent = sweetSpot.toFixed(0) + ' è¬';
        }

        // ========== ç§Ÿæˆ¿è¨ˆç®— ==========
        function updateRentCalculations() {
            const rentMonthly = Utils.getInputValue('rentMonthly');
            const rentIncrease = Utils.getInputValue('rentIncrease') / 100;
            const currentAge = getCurrentAge();
            const targetAge = Utils.getInputValue('targetAge', 65);
            const years = targetAge - currentAge;

            const futureRent = Calculator.futureValue(rentMonthly, rentIncrease, years);
            const totalRent = Calculator.totalRent(rentMonthly, years, rentIncrease);

            document.getElementById('currentRentDisplay').textContent = rentMonthly.toFixed(1) + ' è¬/æœˆ';
            document.getElementById('futureRentDisplay').textContent = futureRent.toFixed(1) + ' è¬/æœˆ';
            document.getElementById('totalRentDisplay').textContent = totalRent.toFixed(0) + ' è¬';
        }

        // ========== å…ˆç§Ÿå¾Œè²·è¨ˆç®— ==========
        function updateMixedCalculations() {
            const rentMonthly = Utils.getInputValue('mixedRentMonthly');
            const rentIncrease = Utils.getInputValue('mixedRentIncrease') / 100;
            const buyAge = Utils.getInputValue('mixedBuyAge', 40);
            const currentAge = getCurrentAge();
            const rentYears = Math.max(0, buyAge - currentAge);

            const housePrice = Utils.getInputValue('mixedHousePrice');
            const downPaymentPercent = Utils.getInputValue('mixedDownPayment') / 100;
            const mortgageRate = Utils.getInputValue('mixedMortgageRate') / 100;

            const totalRent = Calculator.totalRent(rentMonthly, rentYears, rentIncrease);
            const loanAmount = housePrice * (1 - downPaymentPercent);
            const monthlyPayment = Calculator.mortgagePayment(loanAmount, mortgageRate, 30);

            document.getElementById('mixedTotalRentDisplay').textContent = totalRent.toFixed(0) + ' è¬';
            document.getElementById('mixedMonthlyPayment').textContent = monthlyPayment.toFixed(2) + ' è¬/æœˆ';
        }

        // ========== é€€ä¼‘è¨ˆç®— ==========
        /* --------------------------------
         * 9. é€€ä¼‘è¦åŠƒè¨ˆç®—
         * --------------------------------
         * æ–°ç‰ˆè¨­è¨ˆï¼ˆv3.2ï¼‰ï¼š
         *   - ä¸»é¡¯ç¤ºï¼šé€€ä¼‘æ™‚çš„é ä¼°è³‡ç”¢
         *   - 4% æ³•å‰‡ï¼šé¡¯ç¤ºã€Œé”æ¨™å¹´é½¡ã€æˆ–ã€Œé‚„å·®å¤šå°‘ã€
         *   - ç²¾ç®—èŠ±å®Œï¼šé€€ä¼‘å¾Œæ¯æœˆå¯èŠ±å¤šå°‘
         *
         * è¨ˆç®—é‚è¼¯ï¼š
         *   1. ç”¨ calculateAssets() å–å¾—é€å¹´è³‡ç”¢é æ¸¬
         *   2. è¨ˆç®—é€€ä¼‘æ™‚è³‡ç”¢ = projectedValues[retireAge]
         *   3. 4% æ³•å‰‡ç›®æ¨™ = æœˆé–‹éŠ· Ã— 12 / 0.04
         *   4. æ‰¾å‡ºå“ªä¸€å¹´é”æ¨™ï¼ˆéæ­· projectedValuesï¼‰
         *   5. ç²¾ç®—èŠ±å®Œ = é€€ä¼‘è³‡ç”¢ / (é€€ä¼‘å¹´æ•¸ Ã— 12)ï¼ˆç°¡åŒ–ï¼‰
         * -------------------------------- */
        function updateRetireCalculations() {
            const retireAge = Utils.getInputValue('retireAge', 55);
            const lifeExpectancy = Utils.getInputValue('lifeExpectancy', 85);
            const currentExpense = Utils.getInputValue('currentExpense', 3);
            const inflation = Utils.getInputValue('expenseInflation') / 100;
            const annualRate = Utils.getInputValue('annualRate') / 100;
            const currentAge = getCurrentAge();

            const yearsToRetire = retireAge - currentAge;
            const retireYears = lifeExpectancy - retireAge;

            // è¨ˆç®—é€€ä¼‘æ™‚çš„æœˆé–‹éŠ·ï¼ˆè€ƒæ…®é€šè†¨ï¼‰
            const retireExpense = Calculator.futureValue(currentExpense, inflation, yearsToRetire);

            // æ›´æ–°é ‚éƒ¨é¡¯ç¤ºçš„å¹´é½¡å’Œé€€ä¼‘å¹´æ•¸
            document.getElementById('retireAgeDisplay2').textContent = retireAge;
            document.getElementById('lifeDisplay').textContent = lifeExpectancy;
            document.getElementById('retirePeriodDisplay').textContent = retireYears;
            document.getElementById('retirePeriodDisplay2').textContent = retireYears;
            document.getElementById('retireExpenseDisplay').textContent = retireExpense.toFixed(1) + ' è¬/æœˆ';

            // 4% æ³•å‰‡ç›®æ¨™ï¼šå¹´æ”¯å‡º / 4% = æ‰€éœ€æœ¬é‡‘
            const safeAsset = retireExpense * 12 / 0.04;
            document.getElementById('safeAssetDisplay').textContent = safeAsset.toFixed(0) + ' è¬';

            // ç”¨ calculateAssets å–å¾—è³‡ç”¢é æ¸¬
            const targetAge = Utils.getInputValue('targetAge', 65);
            const yearsToProject = Math.max(targetAge, lifeExpectancy) - currentAge;
            const projectedValues = calculateAssets(state.currentStrategy, yearsToProject);

            // æ‰¾å‡ºé€€ä¼‘æ™‚çš„è³‡ç”¢
            const retireYearData = projectedValues.find(v => v.age === retireAge);
            const projectedRetireAsset = retireYearData ? retireYearData.asset : 0;
            document.getElementById('projectedRetireAsset').textContent = projectedRetireAsset.toFixed(0) + ' è¬';

            // æ‰¾å‡º 4% æ³•å‰‡é”æ¨™å¹´é½¡
            let safeRuleAchievedAge = null;
            for (const v of projectedValues) {
                if (v.asset >= safeAsset) {
                    safeRuleAchievedAge = v.age;
                    break;
                }
            }

            // é¡¯ç¤º 4% æ³•å‰‡ç‹€æ…‹
            if (safeRuleAchievedAge !== null) {
                if (safeRuleAchievedAge <= retireAge) {
                    document.getElementById('safeRuleStatus').textContent = `âœ… ${safeRuleAchievedAge}æ­²é”æ¨™`;
                } else {
                    document.getElementById('safeRuleStatus').textContent = `â³ ${safeRuleAchievedAge}æ­²é”æ¨™`;
                }
            } else {
                // è¨ˆç®—é‚„å·®å¤šå°‘
                const shortfall = safeAsset - projectedRetireAsset;
                document.getElementById('safeRuleStatus').textContent = `ğŸ¯ é‚„å·® ${shortfall.toFixed(0)} è¬`;
            }

            // ç²¾ç®—èŠ±å®Œï¼šé€€ä¼‘è³‡ç”¢ / é€€ä¼‘å¹´æ•¸ / 12 = æ¯æœˆå¯èŠ±
            // ç°¡åŒ–è¨ˆç®—ï¼ˆä¸è€ƒæ…®é€€ä¼‘å¾Œçš„æŠ•è³‡å ±é…¬ï¼‰
            const exactMonthly = retireYears > 0 ? projectedRetireAsset / retireYears / 12 : 0;
            document.getElementById('exactMonthlyDisplay').textContent = exactMonthly.toFixed(1) + ' è¬';
        }

        // ========== è³‡ç”¢è¨ˆç®— ==========
        function calculateAssets(strategy, years) {
            const currentValue = Utils.getInputValue('currentValue');
            const monthlyContribution = Utils.getInputValue('monthlyContribution');
            const annualRate = Utils.getInputValue('annualRate') / 100;
            const currentAge = getCurrentAge();

            // é å…ˆå–å¾—ç­–ç•¥é…ç½®ï¼Œé¿å…é‡è¤‡è®€å– DOM
            const strategyConfig = getStrategyConfig(strategy);

            const values = [];
            let asset = currentValue;

            for (let year = 0; year <= years; year++) {
                const age = currentAge + year;

                if (year > 0) {
                    // å¹´åº¦è¤‡åˆ©å¢é•· + å¹´åº¦æŠ•å…¥
                    asset = asset * (1 + annualRate) + monthlyContribution * 12;

                    // ç­–ç•¥ç›¸é—œæ”¯å‡º
                    asset -= calculateStrategyExpense(strategyConfig, age, year);

                    // ç‰¹æ®Šç¾é‡‘æµï¼ˆæ”¶å…¥åŠ å…¥ã€æ”¯å‡ºæ‰£é™¤ï¼‰
                    state.events
                        .filter(e => e.age === age)
                        .forEach(e => {
                            if (e.type === 'income') {
                                asset += e.amount;  // é¡å¤–æŠ•å…¥
                            } else {
                                asset -= e.amount;  // ä¸€æ¬¡æ€§æ”¯å‡º
                            }
                        });
                }

                values.push({ age, asset: Math.max(0, asset) });
            }

            return values;
        }

        // å–å¾—ç­–ç•¥é…ç½®ï¼ˆæ¸›å°‘ DOM è®€å–æ¬¡æ•¸ï¼‰
        function getStrategyConfig(strategy) {
            const config = { strategy };

            if (strategy === 'buy') {
                config.buyAge = Utils.getInputValue('buyAge', 38);
                config.housePrice = Utils.getInputValue('housePrice');
                config.downPaymentPercent = Utils.getInputValue('downPaymentPercent') / 100;
                config.mortgageRate = Utils.getInputValue('mortgageRate') / 100;
                config.mortgageYears = Utils.getInputValue('mortgageYears', 30);
                config.loanAmount = config.housePrice * (1 - config.downPaymentPercent);
                config.monthlyMortgage = Calculator.mortgagePayment(config.loanAmount, config.mortgageRate, config.mortgageYears);
            } else if (strategy === 'rent') {
                config.rentMonthly = Utils.getInputValue('rentMonthly');
                config.rentIncrease = Utils.getInputValue('rentIncrease') / 100;
            } else if (strategy === 'mixed') {
                config.buyAge = Utils.getInputValue('mixedBuyAge', 40);
                config.rentMonthly = Utils.getInputValue('mixedRentMonthly');
                config.rentIncrease = Utils.getInputValue('mixedRentIncrease') / 100;
                config.housePrice = Utils.getInputValue('mixedHousePrice');
                config.downPaymentPercent = Utils.getInputValue('mixedDownPayment') / 100;
                config.mortgageRate = Utils.getInputValue('mixedMortgageRate') / 100;
                config.loanAmount = config.housePrice * (1 - config.downPaymentPercent);
                config.monthlyMortgage = Calculator.mortgagePayment(config.loanAmount, config.mortgageRate, 30);
            }

            return config;
        }

        // è¨ˆç®—ç­–ç•¥æ”¯å‡ºï¼ˆä½¿ç”¨é å…ˆå–å¾—çš„é…ç½®ï¼‰
        function calculateStrategyExpense(config, age, year) {
            const { strategy } = config;

            if (strategy === 'buy') {
                if (age === config.buyAge) return config.housePrice * config.downPaymentPercent;
                if (age > config.buyAge && age <= config.buyAge + config.mortgageYears) {
                    return config.monthlyMortgage * 12;
                }
            } else if (strategy === 'rent') {
                return config.rentMonthly * Math.pow(1 + config.rentIncrease, year) * 12;
            } else if (strategy === 'mixed') {
                // å…ˆç§Ÿå¾Œè²·ï¼šè²·æˆ¿å¹´éœ€è¦ä»˜åŠå¹´ç§Ÿé‡‘ + é ­æœŸæ¬¾
                if (age < config.buyAge) {
                    // è²·æˆ¿å‰ï¼šåªä»˜ç§Ÿé‡‘
                    return config.rentMonthly * Math.pow(1 + config.rentIncrease, year) * 12;
                }
                if (age === config.buyAge) {
                    // è²·æˆ¿å¹´ï¼šåŠå¹´ç§Ÿé‡‘ + é ­æœŸæ¬¾ï¼ˆå‡è¨­å¹´ä¸­è²·æˆ¿ï¼‰
                    const halfYearRent = config.rentMonthly * Math.pow(1 + config.rentIncrease, year) * 6;
                    const downPayment = config.housePrice * config.downPaymentPercent;
                    return halfYearRent + downPayment;
                }
                // è²·æˆ¿å¾Œï¼šä»˜æˆ¿è²¸
                if (age <= config.buyAge + 30) {  // å‡è¨­ 30 å¹´è²¸æ¬¾
                    return config.monthlyMortgage * 12;
                }
            }

            return 0;
        }

        /* --------------------------------
         * 7. åœ–è¡¨ç¹ªè£½åŠŸèƒ½
         * --------------------------------
         * ä½¿ç”¨ Chart.js ç¹ªè£½è³‡ç”¢æˆé•·åœ–
         *
         * è³‡æ–™é›†ï¼š
         *   - æ­·å²æˆæœ¬ç·šï¼ˆç°è‰²è™›ç·šï¼‰
         *   - æ­·å²è³‡ç”¢ç·šï¼ˆç´«è‰²ï¼‰
         *   - é æ¸¬è³‡ç”¢ç·šï¼ˆä¾ç­–ç•¥é¡è‰²ï¼‰
         *
         * ä¸»è¦å‡½æ•¸ï¼š
         *   initChart() - åˆå§‹åŒ–åœ–è¡¨
         *   updateChart() - æ›´æ–°åœ–è¡¨è³‡æ–™
         *   addHistoryDatasets() - æ·»åŠ æ­·å²è³‡æ–™
         *   addCompareDatasets() - æ¯”è¼ƒæ¨¡å¼
         * -------------------------------- */
        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#eee', font: { size: 14 } }
                        },
                        tooltip: {
                            titleFont: { size: 14 },
                            bodyFont: { size: 14 },
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(0)} è¬`
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'å¹´é½¡', color: '#aaa', font: { size: 14 } },
                            ticks: { color: '#aaa', font: { size: 13 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'é‡‘é¡ï¼ˆè¬å…ƒï¼‰', color: '#aaa', font: { size: 14 } },
                            ticks: { color: '#aaa', font: { size: 13 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function updateChart() {
            const currentAge = getCurrentAge();
            const targetAge = Utils.getInputValue('targetAge', 65);

            // è¨ˆç®—èµ·å§‹å¹´é½¡ï¼šå¦‚æœæœ‰æ­·å²è³‡æ–™ï¼Œå¾ç¬¬ä¸€ç­†è¨˜éŒ„é–‹å§‹ï¼›å¦å‰‡å¾ç›®å‰å¹´é½¡é–‹å§‹
            let startAge = currentAge;
            if (state.historyData.length > 0) {
                const firstRecordAge = Utils.getAge(state.historyData[0].date);
                startAge = Math.min(firstRecordAge, currentAge);
            }

            const totalYears = targetAge - startAge;
            const labels = Array.from({ length: totalYears + 1 }, (_, i) => `${startAge + i}æ­²`);
            const datasets = [];

            // æ­·å²è³‡æ–™ç·šï¼ˆå¾ startAge é–‹å§‹ï¼‰
            addHistoryDatasets(datasets, startAge, totalYears);

            // æ¯”è¼ƒæ¨¡å¼æˆ–å–®ä¸€ç­–ç•¥ï¼ˆé æ¸¬ç·šå¾ currentAge é–‹å§‹ï¼Œä½†ç´¢å¼•å°é½Š startAgeï¼‰
            const compareMode = document.getElementById('compareModeToggle').checked;
            let cachedValues = null;
            const currentAgeOffset = currentAge - startAge;

            if (compareMode) {
                addCompareDatasets(datasets, targetAge - currentAge, currentAgeOffset);
            } else {
                // å–®ä¸€ç­–ç•¥æ¨¡å¼æœƒå›å‚³è¨ˆç®—çµæœï¼Œé¿å… updateStats é‡è¤‡è¨ˆç®—
                cachedValues = addSingleStrategyDataset(datasets, targetAge - currentAge, currentAgeOffset);
            }

            state.chart.data.labels = labels;
            state.chart.data.datasets = datasets;
            state.chart.update();

            // å‚³å…¥å·²è¨ˆç®—çš„ valuesï¼Œé¿å…é‡è¤‡è¨ˆç®—
            updateStats(targetAge - currentAge, cachedValues);
        }

        // æ·»åŠ æ­·å²è³‡æ–™åˆ°åœ–è¡¨
        // startAge: åœ–è¡¨èµ·å§‹å¹´é½¡, totalYears: åœ–è¡¨ç¸½å¹´æ•¸
        function addHistoryDatasets(datasets, startAge, totalYears) {
            if (state.historyData.length === 0) return;

            const historyCostData = new Array(totalYears + 1).fill(null);
            const historyAssetData = new Array(totalYears + 1).fill(null);

            state.historyData.forEach(d => {
                const idx = Utils.getAge(d.date) - startAge;
                if (idx >= 0 && idx <= totalYears) {
                    historyCostData[idx] = d.cost;
                    historyAssetData[idx] = d.asset;
                }
            });

            if (historyCostData.some(v => v !== null)) {
                datasets.push({
                    label: 'ğŸ“‰ æ­·å²æˆæœ¬',
                    data: historyCostData,
                    borderColor: CONFIG.COLORS.muted,
                    backgroundColor: CONFIG.COLORS.muted + '1a',
                    borderWidth: 2,
                    pointRadius: 3,
                    fill: true,
                    spanGaps: true  // è·¨è¶Š null å€¼é€£æ¥è³‡æ–™é»
                });
            }

            if (historyAssetData.some(v => v !== null)) {
                datasets.push({
                    label: 'ğŸ“ˆ æ­·å²è³‡ç”¢',
                    data: historyAssetData,
                    borderColor: CONFIG.COLORS.purple,
                    backgroundColor: CONFIG.COLORS.purple + '1a',
                    borderWidth: 2,
                    pointRadius: 3,
                    fill: true,
                    spanGaps: true  // è·¨è¶Š null å€¼é€£æ¥è³‡æ–™é»
                });
            }
        }

        // æ¯”è¼ƒæ¨¡å¼ï¼šæ·»åŠ å¤šç­–ç•¥è³‡æ–™é›†
        // years: é æ¸¬å¹´æ•¸ï¼ˆå¾ç›®å‰å¹´é½¡åˆ°ç›®æ¨™å¹´é½¡ï¼‰
        // offset: é æ¸¬ç·šåœ¨åœ–è¡¨ä¸­çš„èµ·å§‹ç´¢å¼•ï¼ˆç›®å‰å¹´é½¡ - èµ·å§‹å¹´é½¡ï¼‰
        function addCompareDatasets(datasets, years, offset = 0) {
            const strategies = ['none', 'buy', 'rent', 'mixed'];
            const checkboxIds = ['compareNone', 'compareBuy', 'compareRent', 'compareMixed'];

            strategies.forEach((strategy, i) => {
                if (document.getElementById(checkboxIds[i])?.checked) {
                    const values = calculateAssets(strategy, years);
                    const { name, color } = CONFIG.STRATEGIES[strategy];
                    // åœ¨é æ¸¬ç·šå‰é¢å¡«å…… nullï¼Œå°é½Šæ­·å²è³‡æ–™
                    const paddedData = new Array(offset).fill(null).concat(values.map(v => v.asset));
                    datasets.push({
                        label: name,
                        data: paddedData,
                        borderColor: color,
                        borderWidth: 2,
                        pointRadius: 2,
                        fill: false
                    });
                }
            });
        }

        // å–®ä¸€ç­–ç•¥æ¨¡å¼ï¼ˆå›å‚³è¨ˆç®—çµæœä¾›å¾ŒçºŒä½¿ç”¨ï¼‰
        // years: é æ¸¬å¹´æ•¸, offset: é æ¸¬ç·šèµ·å§‹ç´¢å¼•
        function addSingleStrategyDataset(datasets, years, offset = 0) {
            const values = calculateAssets(state.currentStrategy, years);
            const { name, color } = CONFIG.STRATEGIES[state.currentStrategy];

            // åœ¨é æ¸¬ç·šå‰é¢å¡«å…… nullï¼Œå°é½Šæ­·å²è³‡æ–™
            const paddedData = new Array(offset).fill(null).concat(values.map(v => v.asset));
            datasets.push({
                label: name + ' é æ¸¬',
                data: paddedData,
                borderColor: color,
                backgroundColor: color + '20',
                borderWidth: 3,
                pointRadius: 2,
                fill: true
            });

            return values; // å›å‚³ä¾› updateStats ä½¿ç”¨
        }

        /* --------------------------------
         * 10. çµ±è¨ˆé¢æ¿æ›´æ–°ï¼ˆæ•´åˆé‡Œç¨‹ç¢‘èˆ‡å¹´é½¡é æ¸¬ï¼‰
         * --------------------------------
         * é¡¯ç¤ºå…§å®¹ï¼š
         *   1. é‡Œç¨‹ç¢‘ï¼ˆ100è¬ã€200è¬...ï¼‰- å·²é”æˆæˆ–é æ¸¬é”æˆå¹´é½¡
         *   2. é—œéµå¹´é½¡ï¼ˆ35ã€40ã€45...ï¼‰- é æ¸¬è³‡ç”¢
         *
         * æ¨£å¼é¡åˆ¥ï¼š
         *   .milestone-achieved - å·²é”æˆé‡Œç¨‹ç¢‘ï¼ˆç¶ è‰²ï¼‰
         *   .milestone-pending  - æœªé”æˆé‡Œç¨‹ç¢‘ï¼ˆç°è‰²ï¼‰
         *   .age-item          - å¹´é½¡é æ¸¬ï¼ˆé’è‰²ï¼‰
         *   .highlight-retire  - é€€ä¼‘å¹´é½¡ï¼ˆæ©™è‰²ï¼‰
         * -------------------------------- */
        function updateStats(years, cachedValues = null) {
            const currentValue = Utils.getInputValue('currentValue');
            const currentAge = getCurrentAge();
            const retireAge = Utils.getInputValue('retireAge', 55);
            // ä½¿ç”¨å¿«å–çš„è¨ˆç®—çµæœï¼Œé¿å…é‡è¤‡è¨ˆç®—
            const values = cachedValues || calculateAssets(state.currentStrategy, years);

            // ç›®å‰æœ€é«˜è³‡ç”¢ï¼ˆå«æ­·å²ï¼‰
            const latestAsset = state.historyData.length > 0
                ? Math.max(currentValue, state.historyData[state.historyData.length - 1].asset)
                : currentValue;

            const maxPredicted = Math.max(...values.map(v => v.asset));

            // === é‡Œç¨‹ç¢‘éƒ¨åˆ† ===
            const milestonesHtml = CONFIG.MILESTONES.map(target => {
                const achieved = latestAsset >= target;
                let info = '';

                if (achieved && state.historyData.length > 0) {
                    const record = state.historyData.find(r => r.asset >= target);
                    if (record) {
                        info = `${record.date.getFullYear()}/${record.date.getMonth() + 1}`;
                    }
                } else if (!achieved && maxPredicted >= target) {
                    const record = values.find(v => v.asset >= target);
                    if (record) info = `é æ¸¬ ${record.age}æ­²`;
                }

                return `
                    <div class="stat-item ${achieved ? 'milestone-achieved' : 'milestone-pending'}">
                        <div class="label">${achieved ? 'âœ…' : 'ğŸ¯'} ${target} è¬</div>
                        <div class="value">${achieved ? 'é”æˆ' : (info || 'â€”')}</div>
                        ${achieved && info ? `<div class="info">${info}</div>` : ''}
                    </div>
                `;
            }).join('');

            // === åˆ†éš”ç·š ===
            const dividerHtml = '<div class="stats-divider"></div>';

            // === é—œéµå¹´é½¡éƒ¨åˆ† ===
            const agesHtml = CONFIG.DISPLAY_AGES
                .filter(age => age >= currentAge && age <= currentAge + years)
                .map(age => {
                    const asset = values[age - currentAge]?.asset || 0;
                    const isRetire = age === retireAge;

                    return `
                        <div class="stat-item age-item ${isRetire ? 'highlight-retire' : ''}">
                            <div class="label">${age}æ­²${isRetire ? ' ğŸ–ï¸' : ''}</div>
                            <div class="value">${asset.toFixed(0)}</div>
                            <div class="info">è¬</div>
                        </div>
                    `;
                })
                .join('');

            document.getElementById('statsGrid').innerHTML = milestonesHtml + dividerHtml + agesHtml;
        }

        // ========== äº‹ä»¶ç®¡ç† ==========
        // ç›®å‰é¸æ“‡çš„äº‹ä»¶é¡å‹
        let currentEventType = 'income';

        function setEventType(type) {
            currentEventType = type;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // æ›´æ–°é è¨­å€¼
            if (type === 'income') {
                Utils.setInputValue('eventAmount', 10);
                Utils.setInputValue('eventDesc', 'å¹´çµ‚çé‡‘');
            } else {
                Utils.setInputValue('eventAmount', 100);
                Utils.setInputValue('eventDesc', 'è³¼è»Š');
            }
        }

        function addEvent() {
            const age = parseInt(document.getElementById('eventAge').value);
            const amount = parseFloat(document.getElementById('eventAmount').value);
            const desc = document.getElementById('eventDesc').value;
            const type = currentEventType;

            if (age && amount > 0) {
                state.events.push({ age, amount, desc, type });
                refreshEventList();
                updateAllCalculations();
                markCashflowChanged();
                saveAllData();
            }
        }

        // å¿«é€Ÿæ–°å¢äº‹ä»¶ï¼ˆåˆä½µ income/expenseï¼‰
        function quickAddEvent(age, amount, desc, type) {
            state.events.push({ age, amount, desc, type });
            refreshEventList();
            updateAllCalculations();
            markCashflowChanged();
            saveAllData();
        }

        // å‘ä¸‹ç›¸å®¹çš„åŒ…è£å‡½æ•¸
        function quickAddIncome(age, amount, desc) {
            quickAddEvent(age, amount, desc, 'income');
        }

        function quickAddExpense(age, amount, desc) {
            quickAddEvent(age, amount, desc, 'expense');
        }

        function deleteEvent(index) {
            state.events.splice(index, 1);
            refreshEventList();
            updateAllCalculations();
            markCashflowChanged();
            saveAllData();
        }

        function refreshEventList() {
            // æŒ‰å¹´é½¡æ’åº
            const sorted = [...state.events].sort((a, b) => a.age - b.age);

            const html = sorted.map((e, i) => {
                const originalIndex = state.events.indexOf(e);
                const isIncome = e.type === 'income';
                const icon = isIncome ? 'ğŸ’°' : 'ğŸ’¸';
                const sign = isIncome ? '+' : '-';
                const amountClass = isIncome ? 'positive' : 'negative';

                return `
                    <div class="event-item ${e.type || 'expense'}">
                        <span>
                            ${icon} ${e.age}æ­² - ${e.desc}
                            <span class="event-amount ${amountClass}">${sign}${e.amount}è¬</span>
                        </span>
                        <button class="delete-btn" onclick="deleteEvent(${originalIndex})">Ã—</button>
                    </div>
                `;
            }).join('');

            document.getElementById('eventList').innerHTML = html;
        }

        // ========== å·¥å…·å‡½æ•¸ ==========
        function calculateInflation() {
            const amount = Utils.getInputValue('inflationAmount', 100);
            const years = Utils.getInputValue('inflationYears', 20);
            const rate = Utils.getInputValue('inflationRate', 2) / 100;

            const futureValue = Calculator.futureValue(amount, rate, years);
            const purchasingPower = amount / Math.pow(1 + rate, years);

            const result = document.getElementById('inflationResult');
            result.innerHTML = `
                <div>ğŸ’° ${amount} è¬åœ¨ ${years} å¹´å¾Œï¼š</div>
                <div style="margin-top: 5px;">â€¢ ç­‰å€¼è³¼è²·åŠ›ï¼š<strong style="color: var(--color-primary);">${purchasingPower.toFixed(1)} è¬</strong></div>
                <div>â€¢ éœ€è¦ <strong style="color: var(--color-warning);">${futureValue.toFixed(1)} è¬</strong> æ‰æœ‰ç›¸åŒè³¼è²·åŠ›</div>
            `;
            result.classList.add('active');
        }

        // å¾æ­·å²ç´€éŒ„è‡ªå‹•å¸¶å…¥ IRR è¨ˆç®—åƒæ•¸
        function autoFillIRR() {
            // å¾æŠ•è³‡è¦åŠƒå–å¾—æ¯æœˆæŠ•å…¥
            const monthly = Utils.getInputValue('monthlyContribution', 2.5);
            Utils.setInputValue('irrMonthly', monthly);

            // å¾æ­·å²ç´€éŒ„è¨ˆç®—æŠ•è³‡æœˆæ•¸
            if (state.historyData.length >= 2) {
                const first = state.historyData[0];
                const last = state.historyData[state.historyData.length - 1];
                const months = Math.round((last.date - first.date) / (1000 * 60 * 60 * 24 * 30));
                Utils.setInputValue('irrMonths', months);

                // è¨­å®šç›®å‰è³‡ç”¢
                Utils.setInputValue('irrAsset', last.asset.toFixed(1));

                showStatus(`âœ… å·²å¸¶å…¥ï¼š${monthly}è¬/æœˆ Ã— ${months}æœˆ â†’ ${last.asset.toFixed(0)}è¬`, 'success');

                // è‡ªå‹•è¨ˆç®— IRR
                calculateIRR();
            } else {
                showStatus('âš ï¸ éœ€è¦è‡³å°‘ 2 ç­†æ­·å²ç´€éŒ„æ‰èƒ½è¨ˆç®—', 'warning');
            }
        }

        function calculateIRR() {
            const monthly = Utils.getInputValue('irrMonthly', 2.5);
            const months = Utils.getInputValue('irrMonths', 68);
            const asset = Utils.getInputValue('irrAsset', 192);

            const annualRate = Calculator.calculateIRR(monthly, months, asset);
            const totalCost = monthly * months;
            const profit = asset - totalCost;

            const result = document.getElementById('irrResult');
            result.innerHTML = `
                <div>ğŸ“Š IRR è¨ˆç®—çµæœï¼š</div>
                <div style="margin-top: 5px;">â€¢ ç¸½æŠ•å…¥ï¼š<strong>${totalCost.toFixed(1)} è¬</strong></div>
                <div>â€¢ ç²åˆ©ï¼š<strong style="color: ${profit >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};">${profit >= 0 ? '+' : ''}${profit.toFixed(1)} è¬</strong></div>
                <div>â€¢ å¹´åŒ–å ±é…¬ç‡ (IRR)ï¼š<strong style="color: var(--color-primary);">${annualRate.toFixed(2)}%</strong></div>
            `;
            result.classList.add('active');
        }

        // ========== Google Sheet è®€å–ï¼ˆä¸€å€‹ç”¨æˆ¶ä¸€å€‹åˆ†é ï¼‰==========

        /* --------------------------------
         * 4. Google Sheet åŒæ­¥åŠŸèƒ½
         * --------------------------------
         * è®€å–ï¼šfetchSheet() â†’ parseUserSheet() â†’ state
         * å¯«å…¥ï¼šsyncToSheet() â†’ Apps Script â†’ Sheet
         *
         * Sheet æ ¼å¼ï¼š
         *   æ¯å€‹ç”¨æˆ¶ä¸€å€‹åˆ†é ï¼Œåˆ†é åç¨± = ç”¨æˆ¶å
         *   åˆ†é å…§æœ‰å¤šå€‹å€å¡Šï¼šæŠ•è³‡ç´€éŒ„ã€åŸºæœ¬è¨­å®šã€ç‰¹æ®Šç¾é‡‘æµã€ä½æˆ¿è¨­å®š
         *
         * æ³¨æ„ï¼š
         *   - ä½¿ç”¨ JSONP è®€å–ï¼ˆgviz/tq APIï¼‰
         *   - ä½¿ç”¨ Apps Script POST å¯«å…¥
         *   - headers=0 åƒæ•¸é¿å… API æŠŠè¡Œç•¶æ¨™é¡Œ
         * -------------------------------- */

        // å–å¾—ç”¨æˆ¶åˆ†é åç¨±
        function getUserSheetName(userId = state.currentUser) {
            return CONFIG.USERS[userId]?.name || userId;
        }

        // è®€å–å–®ä¸€åˆ†é ï¼ˆJSONP æ–¹å¼ï¼‰
        function fetchSheet(sheetId, sheetName) {
            return new Promise((resolve, reject) => {
                const callbackName = 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                // headers=0 å‘Šè¨´ API ä¸è¦æŠŠä»»ä½•è¡Œç•¶ä½œæ¨™é¡Œ
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json;responseHandler:${callbackName}&sheet=${encodeURIComponent(sheetName)}&headers=0`;

                const timeout = setTimeout(() => {
                    delete window[callbackName];
                    if (script.parentNode) document.body.removeChild(script);
                    reject(new Error(`è®€å– "${sheetName}" è¶…æ™‚`));
                }, 10000);

                window[callbackName] = function(response) {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    if (script.parentNode) document.body.removeChild(script);

                    if (response.status === 'error') {
                        // åˆ†é ä¸å­˜åœ¨æ™‚ä¸å ±éŒ¯ï¼Œè¿”å›ç©ºè³‡æ–™
                        resolve({ table: { rows: [] }, sheetName });
                    } else {
                        resolve({ ...response, sheetName });
                    }
                };

                const script = document.createElement('script');
                script.src = url;
                script.onerror = () => {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    if (script.parentNode) document.body.removeChild(script);
                    resolve({ table: { rows: [] }, sheetName }); // å¤±æ•—æ™‚è¿”å›ç©ºè³‡æ–™
                };
                document.body.appendChild(script);
            });
        }

        // ä¸»è¦è®€å–å‡½æ•¸ï¼ˆè®€å–ç”¨æˆ¶åˆ†é ï¼‰
        async function loadSheetData() {
            const sheetId = document.getElementById('sheetId').value.trim();

            if (!sheetId) {
                showStatus('è«‹è¼¸å…¥ Google Sheet ID', 'error');
                return;
            }

            localStorage.setItem('investmentSheetId', sheetId);

            const btn = document.getElementById('loadBtn');
            btn.disabled = true;
            btn.textContent = 'è¼‰å…¥ä¸­...';

            const userSheetName = getUserSheetName();
            showStatus(`æ­£åœ¨è®€å–ã€Œ${userSheetName}ã€åˆ†é ...`, 'loading');

            try {
                // è®€å–ç”¨æˆ¶åˆ†é 
                const response = await fetchSheet(sheetId, userSheetName);

                if (!response.table?.rows?.length) {
                    throw new Error(`æ‰¾ä¸åˆ°ã€Œ${userSheetName}ã€åˆ†é æˆ–åˆ†é ç‚ºç©º`);
                }

                // è§£æåˆä½µåˆ†é 
                parseUserSheet(response.table);

                const summary = [];
                if (state.historyData.length > 0) summary.push(`${state.historyData.length} ç­†ç´€éŒ„`);
                if (state.events.length > 0) summary.push(`${state.events.length} ç­†ç¾é‡‘æµ`);

                showStatus(`âœ… æˆåŠŸè¼‰å…¥ï¼š${summary.join('ã€') || 'è¨­å®š'}`, 'success');
                onHistoryDataLoaded();

            } catch (error) {
                console.error('Load error:', error);
                showStatus('è®€å–å¤±æ•—ï¼š' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“¥ è®€å–';
            }
        }

        // è§£æç”¨æˆ¶åˆ†é ï¼ˆåŒ…å«æ‰€æœ‰å€å¡Šï¼‰
        function parseUserSheet(table) {
            // é‡ç½® state
            state.historyData = [];
            state.events = [];

            let currentSection = null;
            const tempSettings = {};
            const tempHousing = {};

            for (const row of table.rows) {
                if (!row.c || row.c.length === 0) continue;

                const firstCell = row.c[0]?.v?.toString().trim() || '';

                // æª¢æ¸¬å€å¡Šæ¨™é¡Œ
                if (firstCell.startsWith('ã€') && firstCell.endsWith('ã€‘')) {
                    currentSection = firstCell.replace(/[ã€ã€‘]/g, '');
                    continue;
                }

                // è·³éæ¨™é¡Œè¡Œ
                if (['æ—¥æœŸ', 'é …ç›®', 'å¹´é½¡'].includes(firstCell)) continue;

                // æ ¹æ“šå€å¡Šè§£æ
                if (currentSection === 'æŠ•è³‡ç´€éŒ„') {
                    const date = row.c[0] ? (Utils.parseDate(row.c[0].v) || Utils.parseDate(row.c[0].f)) : null;
                    const cost = parseSheetNum(row.c[1]);
                    const asset = parseSheetNum(row.c[2]);
                    const note = row.c[3]?.v ? String(row.c[3].v) : '';

                    if (date && !isNaN(cost) && !isNaN(asset) && cost > 0) {
                        state.historyData.push({ date, cost, asset, note });
                    }
                } else if (currentSection === 'åŸºæœ¬è¨­å®š') {
                    const key = firstCell;
                    const value = row.c[1]?.v;
                    if (key && value !== undefined) {
                        tempSettings[key] = value;
                    }
                } else if (currentSection === 'ç‰¹æ®Šç¾é‡‘æµ') {
                    const age = parseSheetNum(row.c[0]);
                    const typeStr = row.c[1]?.v?.toString().trim() || '';
                    const amount = parseSheetNum(row.c[2]);
                    const desc = row.c[3]?.v ? String(row.c[3].v) : '';

                    const type = (typeStr === 'æ”¶å…¥' || typeStr.toLowerCase() === 'income') ? 'income' : 'expense';

                    if (age > 0 && amount > 0) {
                        state.events.push({ age, amount, desc, type });
                    }
                } else if (currentSection === 'ä½æˆ¿è¨­å®š') {
                    const key = firstCell;
                    const value = row.c[1]?.v;
                    if (key && value !== undefined) {
                        tempHousing[key] = value;
                    }
                }
            }

            // æ’åºæ­·å²è³‡æ–™
            state.historyData.sort((a, b) => a.date - b.date);

            // å¥—ç”¨åŸºæœ¬è¨­å®š
            applySettings(tempSettings);

            // å¥—ç”¨ä½æˆ¿è¨­å®š
            applyHousingSettings(tempHousing);

            // åˆ·æ–°äº‹ä»¶åˆ—è¡¨
            refreshEventList();
        }

        // å¥—ç”¨åŸºæœ¬è¨­å®šåˆ°è¡¨å–®
        function applySettings(settings) {
            const mapping = {
                'æ¯æœˆæŠ•å…¥': 'monthlyContribution',
                'é ä¼°å ±é…¬ç‡': 'annualRate',
                'é€€ä¼‘å¹´é½¡': 'retireAge',
                'é ä¼°å£½å‘½': 'lifeExpectancy',
                'æ¯æœˆé–‹éŠ·': 'currentExpense',
                'é€šè†¨ç‡': 'expenseInflation',
                'é æ¸¬è‡³å¹´é½¡': 'targetAge'
            };

            Object.entries(mapping).forEach(([sheetKey, inputId]) => {
                if (settings[sheetKey] !== undefined) {
                    Utils.setInputValue(inputId, settings[sheetKey]);
                }
            });

            if (settings['é ä¼°å ±é…¬ç‡']) {
                document.getElementById('rateDisplay').textContent = settings['é ä¼°å ±é…¬ç‡'] + '%';
            }
        }

        // å¥—ç”¨ä½æˆ¿è¨­å®š
        function applyHousingSettings(settings) {
            const mapping = {
                'è³¼æˆ¿å¹´é½¡': 'buyAge',
                'æˆ¿åƒ¹': 'housePrice',
                'é ­æœŸæ¬¾%': 'downPaymentPercent',
                'è²¸æ¬¾åˆ©ç‡': 'mortgageRate',
                'è²¸æ¬¾å¹´é™': 'mortgageYears',
                'æˆ¿åƒ¹å¹´æ¼²%': 'houseAppreciation',
                'æœˆç§Ÿé‡‘': 'rentMonthly',
                'ç§Ÿé‡‘æ¼²å¹…%': 'rentIncrease',
                'å…ˆç§Ÿæœˆç§Ÿ': 'mixedRentMonthly',
                'å…ˆç§Ÿæ¼²å¹…%': 'mixedRentIncrease',
                'å…ˆç§Ÿå¾Œè²·å¹´é½¡': 'mixedBuyAge',
                'å…ˆç§Ÿå¾Œè²·æˆ¿åƒ¹': 'mixedHousePrice',
                'å…ˆç§Ÿå¾Œè²·é ­æœŸ%': 'mixedDownPayment',
                'å…ˆç§Ÿå¾Œè²·åˆ©ç‡': 'mixedMortgageRate'
            };

            Object.entries(mapping).forEach(([sheetKey, inputId]) => {
                if (settings[sheetKey] !== undefined) {
                    Utils.setInputValue(inputId, settings[sheetKey]);
                }
            });

            const strategy = settings['ç­–ç•¥']?.toString().toLowerCase();
            if (['none', 'buy', 'rent', 'mixed'].includes(strategy)) {
                selectStrategy(strategy);
            }
        }

        // è¼”åŠ©ï¼šè§£ææ•¸å€¼
        function parseSheetNum(cell) {
            if (!cell?.v) return 0;
            return typeof cell.v === 'number' ? cell.v : parseFloat(String(cell.v).replace(/,/g, ''));
        }

        /* --------------------------------
         * 6. æ­·å²å›é¡§åŠŸèƒ½
         * --------------------------------
         * é¡¯ç¤ºå…§å®¹ï¼š
         *   - ç¸½æŠ•å…¥ï¼ˆæœ€æ–°ç´€éŒ„çš„ costï¼‰
         *   - ç›®å‰è³‡ç”¢ï¼ˆæœ€æ–°ç´€éŒ„çš„ assetï¼‰
         *   - ç¸½ç²åˆ©ï¼ˆé‡‘é¡ + ç™¾åˆ†æ¯”ï¼‰
         *   - æŠ•è³‡æœŸé–“ï¼ˆç¬¬ä¸€ç­†åˆ°æœ€å¾Œä¸€ç­†ï¼‰
         *
         * æ³¨æ„ï¼š
         *   å·²ç§»é™¤ IRR å’Œè¿‘æœŸ/é•·æœŸç¸¾æ•ˆé¡¯ç¤º
         *   å› ç‚ºå¿«ç…§å¼ç´€éŒ„ç„¡æ³•æº–ç¢ºè¨ˆç®—æ™‚é–“åŠ æ¬Šå ±é…¬
         * -------------------------------- */
        function onHistoryDataLoaded() {
            if (!state.historyData || state.historyData.length === 0) {
                document.getElementById('historySummary').classList.remove('active');
                return;
            }

            // è¨ˆç®—æ­·å² IRR
            state.historicalIRR = calculateHistoricalIRR();

            const first = state.historyData[0];
            const last = state.historyData[state.historyData.length - 1];

            // è¨ˆç®—åŸºæœ¬æ•¸æ“š
            const totalCost = last.cost;
            const currentAsset = last.asset;
            const profit = currentAsset - totalCost;
            const profitPercent = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

            // è¨ˆç®—æŠ•è³‡æœŸé–“
            const months = Math.round((last.date - first.date) / (1000 * 60 * 60 * 24 * 30));
            const years = Math.floor(months / 12);
            const remainMonths = months % 12;
            const periodText = years > 0
                ? `${years} å¹´ ${remainMonths} å€‹æœˆ`
                : `${months} å€‹æœˆ`;

            // æ›´æ–°ç¸½è¦½
            document.getElementById('historyCost').textContent = totalCost.toFixed(0) + ' è¬';
            document.getElementById('historyAsset').textContent = currentAsset.toFixed(0) + ' è¬';
            document.getElementById('historyProfit').textContent =
                (profit >= 0 ? '+' : '') + profit.toFixed(0) + ' è¬ï¼ˆ' +
                (profitPercent >= 0 ? '+' : '') + profitPercent.toFixed(1) + '%ï¼‰';
            document.getElementById('historyPeriod').textContent = periodText;

            // æ›´æ–°æŠ•è³‡è¦åŠƒçš„ã€Œç›®å‰è³‡ç”¢ã€
            document.getElementById('currentValue').value = currentAsset.toFixed(0);
            updateHeaderAsset(currentAsset);

            document.getElementById('historySummary').classList.add('active');

            // æ¸²æŸ“æ­·å²ç´€éŒ„åˆ—è¡¨
            renderHistoryList();

            updateChart();
        }

        // å±•é–‹/æ”¶åˆæ­·å²ç´€éŒ„åˆ—è¡¨
        function toggleHistoryList() {
            const container = document.getElementById('historyListContainer');
            const toggleText = document.getElementById('historyListToggleText');
            const isExpanded = container.classList.toggle('expanded');

            toggleText.textContent = isExpanded ? 'ğŸ“‹ æ”¶åˆè©³ç´°ç´€éŒ„' : 'ğŸ“‹ å±•é–‹è©³ç´°ç´€éŒ„';
        }

        // æ¸²æŸ“æ­·å²ç´€éŒ„åˆ—è¡¨
        function renderHistoryList() {
            const tbody = document.getElementById('historyTableBody');
            const countSpan = document.getElementById('historyListCount');

            if (!state.historyData || state.historyData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="color: var(--color-text-muted);">å°šç„¡ç´€éŒ„</td></tr>';
                countSpan.textContent = '';
                return;
            }

            countSpan.textContent = `ï¼ˆ${state.historyData.length} ç­†ï¼‰`;

            // æŒ‰æ—¥æœŸå€’åºé¡¯ç¤ºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            const sortedData = [...state.historyData].sort((a, b) => b.date - a.date);

            tbody.innerHTML = sortedData.map((record, sortedIndex) => {
                // æ‰¾åˆ°åŸå§‹ indexï¼ˆç”¨æ–¼åˆªé™¤ï¼‰
                const originalIndex = state.historyData.findIndex(
                    r => r.date.getTime() === record.date.getTime()
                );
                const dateStr = record.date.toISOString().split('T')[0];
                const noteHtml = record.note
                    ? `<span title="${record.note}">${record.note}</span>`
                    : '<span style="color: var(--color-text-muted);">-</span>';

                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${record.cost.toFixed(1)}</td>
                        <td>${record.asset.toFixed(1)}</td>
                        <td class="note">${noteHtml}</td>
                        <td class="delete-btn" onclick="deleteHistoryRecord(${originalIndex})" title="åˆªé™¤">âœ•</td>
                    </tr>
                `;
            }).join('');
        }

        // åˆªé™¤æ­·å²ç´€éŒ„
        async function deleteHistoryRecord(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;

            const sheetId = document.getElementById('sheetId').value.trim();
            const url = document.getElementById('appsScriptUrl').value.trim();

            // â˜… å…ˆå¾ Sheet è¼‰å…¥æœ€æ–°è³‡æ–™
            if (sheetId) {
                try {
                    const userSheetName = getUserSheetName();
                    const response = await fetchSheet(sheetId, userSheetName);
                    if (response.table?.rows?.length) {
                        parseUserSheet(response.table);
                    }
                } catch (error) {
                    console.log('Pre-load skipped:', error.message);
                }
            }

            // é‡æ–°è¨ˆç®— indexï¼ˆå› ç‚ºè³‡æ–™å¯èƒ½å·²æ›´æ–°ï¼‰
            if (index >= state.historyData.length) {
                showStatus('ç´€éŒ„å·²ä¸å­˜åœ¨', 'error');
                renderHistoryList();
                return;
            }

            state.historyData.splice(index, 1);

            if (state.historyData.length > 0) {
                onHistoryDataLoaded();
                saveAllData();

                // åŒæ­¥åˆ° Sheet
                if (url) {
                    await syncAllToSheet('æ­£åœ¨åŒæ­¥åˆªé™¤...');
                    showStatus('âœ… å·²åˆªé™¤ä¸¦åŒæ­¥', 'success');
                }
            } else {
                // æ²’æœ‰ç´€éŒ„äº†
                document.getElementById('historySummary').classList.remove('active');
                updateHeaderAsset(null);
                renderHistoryList();
                saveAllData();

                // åŒæ­¥ç©ºè³‡æ–™åˆ° Sheet
                if (url) {
                    await syncAllToSheet('æ­£åœ¨åŒæ­¥...');
                }
            }
        }

        function calculateHistoricalIRR() {
            if (state.historyData.length < 2) return 0;

            // ä½¿ç”¨å¯¦éš›ç¾é‡‘æµè¨ˆç®— IRR
            // å»ºç«‹æ¯æœˆçš„ç¾é‡‘æµåºåˆ—
            const first = state.historyData[0];
            const last = state.historyData[state.historyData.length - 1];

            // è¨ˆç®—æ¯æœŸçš„æŠ•å…¥é‡‘é¡ï¼ˆæœ¬æœŸæˆæœ¬ - ä¸ŠæœŸæˆæœ¬ï¼‰
            const cashflows = [];
            let prevCost = 0;

            for (let i = 0; i < state.historyData.length; i++) {
                const record = state.historyData[i];
                const contribution = record.cost - prevCost;
                if (contribution > 0) {
                    cashflows.push({
                        date: record.date,
                        amount: -contribution  // æŠ•å…¥ç‚ºè² æ•¸ï¼ˆæµå‡ºï¼‰
                    });
                }
                prevCost = record.cost;
            }

            // åŠ å…¥æœ€çµ‚è³‡ç”¢åƒ¹å€¼ï¼ˆæµå…¥ï¼‰
            cashflows.push({
                date: last.date,
                amount: last.asset
            });

            // ä½¿ç”¨ XIRR è¨ˆç®—ï¼ˆè€ƒæ…®å¯¦éš›æ—¥æœŸï¼‰
            return calculateXIRR(cashflows);
        }

        // XIRR è¨ˆç®—ï¼ˆè€ƒæ…®å¯¦éš›æ—¥æœŸçš„ IRRï¼‰
        function calculateXIRR(cashflows, guess = 0.1) {
            if (cashflows.length < 2) return 0;

            const firstDate = cashflows[0].date;
            const daysInYear = 365;

            // è¨ˆç®—æ¯ç­†ç¾é‡‘æµè·é›¢ç¬¬ä¸€ç­†çš„å¹´æ•¸
            const flows = cashflows.map(cf => ({
                amount: cf.amount,
                years: (cf.date - firstDate) / (daysInYear * 24 * 60 * 60 * 1000)
            }));

            // Newton-Raphson è¿­ä»£æ±‚è§£
            let rate = guess;
            const maxIterations = 100;
            const tolerance = 0.0001;

            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let derivative = 0;

                for (const flow of flows) {
                    const factor = Math.pow(1 + rate, flow.years);
                    npv += flow.amount / factor;
                    derivative -= flow.years * flow.amount / (factor * (1 + rate));
                }

                if (Math.abs(npv) < tolerance) {
                    return rate * 100;  // è½‰ç‚ºç™¾åˆ†æ¯”
                }

                if (Math.abs(derivative) < 1e-10) {
                    break;  // é¿å…é™¤ä»¥é›¶
                }

                rate = rate - npv / derivative;

                // é™åˆ¶ç¯„åœé¿å…ç™¼æ•£
                if (rate < -0.99) rate = -0.99;
                if (rate > 10) rate = 10;
            }

            // è‹¥ Newton-Raphson å¤±æ•—ï¼Œä½¿ç”¨äºŒåˆ†æ³•
            return calculateXIRRBisection(flows);
        }

        // äºŒåˆ†æ³•è¨ˆç®— XIRRï¼ˆå‚™ç”¨æ–¹æ³•ï¼‰
        function calculateXIRRBisection(flows) {
            let low = -0.99;
            let high = 10;
            const tolerance = 0.0001;

            for (let i = 0; i < 100; i++) {
                const mid = (low + high) / 2;
                let npv = 0;

                for (const flow of flows) {
                    npv += flow.amount / Math.pow(1 + mid, flow.years);
                }

                if (Math.abs(npv) < tolerance) {
                    return mid * 100;
                }

                if (npv > 0) {
                    low = mid;
                } else {
                    high = mid;
                }
            }

            return ((low + high) / 2) * 100;
        }

        // ========== å¥—ç”¨æ­·å²è³‡æ–™åˆ°æ¨¡æ“¬å™¨ ==========
        function applyHistoryToSimulator() {
            if (state.historyData.length === 0) {
                showStatus('æ²’æœ‰æ­·å²è³‡æ–™å¯å¥—ç”¨', 'error');
                return;
            }

            const first = state.historyData[0];
            const last = state.historyData[state.historyData.length - 1];
            const applied = [];

            // æ›´æ–°ç›®å‰è³‡ç”¢
            Utils.setInputValue('currentValue', last.asset.toFixed(0));
            updateHeaderAsset(last.asset);
            applied.push(`è³‡ç”¢ ${last.asset.toFixed(0)} è¬`);

            // æ›´æ–°å¹´åŒ–å ±é…¬ç‡ï¼ˆå¦‚æœæ­·å² IRR åœ¨åˆç†ç¯„åœå…§ï¼‰
            if (state.historicalIRR >= 4 && state.historicalIRR <= 25) {
                Utils.setInputValue('annualRate', state.historicalIRR.toFixed(1));
                document.getElementById('rateDisplay').textContent = state.historicalIRR.toFixed(1) + '%';
                applied.push(`å ±é…¬ç‡ ${state.historicalIRR.toFixed(1)}%`);
            } else if (state.historicalIRR > 25) {
                // IRR è¶…å‡ºç¯„åœï¼Œä½¿ç”¨ä¸Šé™
                Utils.setInputValue('annualRate', '20');
                document.getElementById('rateDisplay').textContent = '20%';
                applied.push(`å ±é…¬ç‡ 20%ï¼ˆIRR ${state.historicalIRR.toFixed(0)}% è¶…å‡ºç¯„åœï¼‰`);
            }

            // è¨ˆç®—æ¯æœˆæŠ•å…¥
            const months = (last.date.getFullYear() - first.date.getFullYear()) * 12 +
                          (last.date.getMonth() - first.date.getMonth());
            if (months > 0) {
                const monthlyAvg = (last.cost / months).toFixed(1);
                Utils.setInputValue('monthlyContribution', monthlyAvg);
                applied.push(`æœˆæŠ•å…¥ ${monthlyAvg} è¬`);
            }

            showStatus(`âœ… å·²å¥—ç”¨ï¼š${applied.join('ã€')}`, 'success');
            updateAllCalculations();
        }


        // ========== æ¸¬è©¦é€£ç·š ==========
        async function testConnection() {
            const url = document.getElementById('appsScriptUrl').value.trim();
            const statusEl = document.getElementById('connectionStatus');
            const btn = document.getElementById('testConnBtn');

            if (!url) {
                statusEl.innerHTML = '<span style="color: var(--color-danger);">è«‹å…ˆå¡«å…¥ URL</span>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æ¸¬è©¦ä¸­...';
            statusEl.innerHTML = '<span style="color: var(--color-warning);">â³</span>';

            try {
                // ä½¿ç”¨ doGet æ¸¬è©¦é€£ç·š
                const testUrl = url.replace('/exec', '/exec?test=1');
                const response = await fetch(testUrl, { method: 'GET' });

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'ok') {
                        state.connectionVerified = true;
                        localStorage.setItem('appsScriptUrl', url);
                        statusEl.innerHTML = '<span style="color: var(--color-success);">âœ… é€£ç·šæˆåŠŸ</span>';
                        showStatus('é€£ç·šæ¸¬è©¦æˆåŠŸï¼', 'success');
                    } else {
                        throw new Error('å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                // ç”±æ–¼ CORS é™åˆ¶ï¼ŒGET å¯èƒ½æœƒå¤±æ•—ï¼Œä½†ä¸ä»£è¡¨ POST ä¸è¡Œ
                // ä¿å­˜ URL ä¸¦çµ¦äºˆè­¦å‘Š
                localStorage.setItem('appsScriptUrl', url);
                state.connectionVerified = false;
                statusEl.innerHTML = '<span style="color: var(--color-warning);">âš ï¸ ç„¡æ³•é©—è­‰ï¼ˆCORSï¼‰</span>';
                showStatus('ç„¡æ³•é©—è­‰é€£ç·šï¼ˆCORS é™åˆ¶ï¼‰ï¼Œä½† URL å·²å„²å­˜', 'loading');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ” æ¸¬è©¦é€£ç·š';
            }
        }

        /* --------------------------------
         * 5. å¿«é€Ÿè¨˜éŒ„åŠŸèƒ½
         * --------------------------------
         * âš ï¸ é™åˆ¶èªªæ˜ï¼š
         *   æ­¤åŠŸèƒ½è¨˜éŒ„ã€Œç´¯è¨ˆæˆæœ¬ã€èˆ‡ã€Œç•¶å‰è³‡ç”¢ã€çš„å¿«ç…§
         *   ä¸è¨˜éŒ„æ¯ç­†å®šæœŸå®šé¡çš„æŠ•å…¥æ™‚é–“
         *   å› æ­¤ç„¡æ³•è¨ˆç®—ç²¾ç¢ºçš„æ™‚é–“åŠ æ¬Šå ±é…¬ï¼ˆXIRRï¼‰
         *
         * æµç¨‹ï¼š
         *   1. å…ˆå¾ Sheet è¼‰å…¥ç¾æœ‰è³‡æ–™ï¼ˆé¿å…è¦†è“‹ï¼‰
         *   2. æ–°å¢/æ›´æ–°ç´€éŒ„åˆ° state.historyData
         *   3. åŒæ­¥å®Œæ•´è³‡æ–™åˆ° Sheet
         *   4. æ›´æ–° UIï¼ˆæ­·å²å›é¡§ã€åœ–è¡¨ï¼‰
         *
         * é©ç”¨å ´æ™¯ï¼š
         *   - å®šæœŸè¨˜éŒ„è³‡ç”¢ç‹€æ…‹ï¼ˆå¦‚æ¯æœˆåº•ï¼‰
         *   - è¿½è¹¤è³‡ç”¢æˆé•·è»Œè·¡
         * -------------------------------- */
        async function quickRecordAndSync() {
            const date = document.getElementById('quickRecordDate').value;
            const cost = parseFloat(document.getElementById('quickRecordCost').value);
            const asset = parseFloat(document.getElementById('quickRecordAsset').value);
            const note = document.getElementById('quickRecordNote').value.trim();
            const url = document.getElementById('appsScriptUrl').value.trim();
            const sheetId = document.getElementById('sheetId').value.trim();

            // é©—è­‰
            if (!date) {
                showStatus('è«‹é¸æ“‡æ—¥æœŸ', 'error');
                return;
            }
            if (!cost || cost <= 0) {
                showStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„æœ¬é‡‘', 'error');
                return;
            }
            if (!asset || asset <= 0) {
                showStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„è³‡ç”¢', 'error');
                return;
            }
            if (!url) {
                showStatus('è«‹å…ˆè¨­å®š Apps Script URL', 'error');
                return;
            }
            if (!sheetId) {
                showStatus('è«‹å…ˆè¨­å®š Sheet ID', 'error');
                return;
            }

            // â˜… é‡è¦ï¼šåŒæ­¥å‰å…ˆå¾ Sheet è¼‰å…¥æœ€æ–°è³‡æ–™ï¼Œé¿å…è¦†è“‹
            showStatus('æ­£åœ¨è¼‰å…¥ Sheet è³‡æ–™...', 'loading');
            const previousCount = state.historyData.length;
            try {
                const userSheetName = getUserSheetName();
                const response = await fetchSheet(sheetId, userSheetName);
                if (response.table?.rows?.length) {
                    parseUserSheet(response.table);
                }
            } catch (error) {
                console.error('Pre-load failed:', error);
                // è¼‰å…¥å¤±æ•—æ™‚è­¦å‘Šç”¨æˆ¶
                if (previousCount === 0) {
                    const proceed = confirm('âš ï¸ ç„¡æ³•å¾ Sheet è¼‰å…¥ç¾æœ‰è³‡æ–™ï¼Œç¹¼çºŒå¯èƒ½æœƒè¦†è“‹èˆŠè³‡æ–™ã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ');
                    if (!proceed) {
                        showStatus('å·²å–æ¶ˆ', 'warning');
                        return;
                    }
                }
            }

            // æ–°å¢åˆ°æ­·å²è³‡æ–™
            const newRecord = {
                date: new Date(date),
                cost: cost,
                asset: asset,
                note: note
            };

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒæ—¥æœŸçš„ç´€éŒ„
            const existingIndex = state.historyData.findIndex(
                h => h.date.toISOString().split('T')[0] === date
            );

            if (existingIndex >= 0) {
                // æ›´æ–°ç¾æœ‰ç´€éŒ„
                state.historyData[existingIndex] = newRecord;
            } else {
                // æ–°å¢ç´€éŒ„
                state.historyData.push(newRecord);
            }

            // æ’åºï¼ˆç¢ºä¿æŒ‰æ—¥æœŸæ’åˆ—ï¼‰
            state.historyData.sort((a, b) => a.date - b.date);

            // æ›´æ–°è¡¨å–®çš„ç›®å‰è³‡ç”¢ï¼ˆç”¨æœ€æ–°ä¸€ç­†ç´€éŒ„çš„è³‡ç”¢ï¼Œè€Œéå‰›è¼¸å…¥çš„ï¼‰
            const latestRecord = state.historyData[state.historyData.length - 1];
            Utils.setInputValue('currentValue', latestRecord.asset.toFixed(0));
            updateHeaderAsset(latestRecord.asset);

            // åŒæ­¥æ‰€æœ‰è³‡æ–™åˆ° Sheet
            const success = await syncAllToSheet('æ­£åœ¨åŒæ­¥...');

            if (success) {
                // æ›´æ–° UI
                onHistoryDataLoaded();
                saveAllData();

                showStatus(`âœ… å·²è¨˜éŒ„ ${date} çš„æ”¶ç›Šä¸¦åŒæ­¥åˆ°ã€Œ${getUserSheetName()}ã€`, 'success');

                // æ¸…ç©ºè¼¸å…¥
                document.getElementById('quickRecordCost').value = '';
                document.getElementById('quickRecordAsset').value = '';
                document.getElementById('quickRecordNote').value = '';
                document.getElementById('quickRecordResult').classList.remove('active');
            }
        }

        // ========== åŒæ­¥ç¾é‡‘æµåˆ° Sheet ==========
        async function syncCashflowToSheet() {
            // åŒæ­¥æ‰€æœ‰è³‡æ–™ï¼ˆåŒ…å«ç¾é‡‘æµï¼‰
            const success = await syncAllToSheet('æ­£åœ¨åŒæ­¥ç¾é‡‘æµ...');

            if (success) {
                state.cashflowChanged = false;
                document.getElementById('cashflowSyncSection').style.display = 'none';
                showStatus(`âœ… å·²åŒæ­¥åˆ°ã€Œ${getUserSheetName()}ã€åˆ†é `, 'success');
                saveAllData();
            }
        }

        // æ¨™è¨˜ç¾é‡‘æµæœ‰è®Šæ›´
        function markCashflowChanged() {
            state.cashflowChanged = true;
            document.getElementById('cashflowSyncSection').style.display = 'block';
        }

        // ========== çµ±ä¸€åŒæ­¥å‡½æ•¸ ==========

        // å–å¾—å®Œæ•´åŒæ­¥è³‡æ–™
        function getFullSyncData() {
            return {
                action: 'saveAll',
                userName: getUserSheetName(),

                // æŠ•è³‡ç´€éŒ„
                history: state.historyData.map(h => ({
                    date: h.date.toISOString().split('T')[0],
                    cost: h.cost,
                    asset: h.asset,
                    note: h.note || ''
                })),

                // åŸºæœ¬è¨­å®š
                settings: {
                    monthlyContribution: Utils.getInputValue('monthlyContribution'),
                    annualRate: Utils.getInputValue('annualRate'),
                    retireAge: Utils.getInputValue('retireAge'),
                    lifeExpectancy: Utils.getInputValue('lifeExpectancy'),
                    currentExpense: Utils.getInputValue('currentExpense'),
                    expenseInflation: Utils.getInputValue('expenseInflation'),
                    targetAge: Utils.getInputValue('targetAge')
                },

                // ç‰¹æ®Šç¾é‡‘æµ
                cashflow: state.events.map(e => ({
                    age: e.age,
                    type: e.type,
                    amount: e.amount,
                    desc: e.desc
                })),

                // ä½æˆ¿è¨­å®š
                housing: {
                    strategy: state.currentStrategy,
                    buyAge: Utils.getInputValue('buyAge'),
                    housePrice: Utils.getInputValue('housePrice'),
                    downPaymentPercent: Utils.getInputValue('downPaymentPercent'),
                    mortgageRate: Utils.getInputValue('mortgageRate'),
                    mortgageYears: Utils.getInputValue('mortgageYears'),
                    houseAppreciation: Utils.getInputValue('houseAppreciation'),
                    rentMonthly: Utils.getInputValue('rentMonthly'),
                    rentIncrease: Utils.getInputValue('rentIncrease')
                }
            };
        }

        // åŒæ­¥æ‰€æœ‰è³‡æ–™åˆ° Sheet
        async function syncAllToSheet(statusMessage = 'æ­£åœ¨åŒæ­¥...') {
            const url = document.getElementById('appsScriptUrl').value.trim();

            if (!url) {
                showStatus('è«‹å…ˆè¨­å®š Apps Script URLï¼ˆè¨­å®šèˆ‡å·¥å…· â†’ Sheet é€£æ¥è¨­å®šï¼‰', 'error');
                return false;
            }

            showStatus(statusMessage, 'loading');

            try {
                const data = getFullSyncData();

                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                return true;
            } catch (error) {
                console.error('Sync error:', error);
                showStatus('åŒæ­¥å¤±æ•—ï¼š' + error.message, 'error');
                return false;
            }
        }

        // ========== è³‡æ–™å„²å­˜/è¼‰å…¥ ==========

        // å„²å­˜æ‰€æœ‰è³‡æ–™åˆ° localStorage
        // å„²å­˜è¨­å®šåˆ° localStorageï¼ˆåªå„²å­˜é€£ç·šè¨­å®šï¼Œä¸å„²å­˜ç”¨æˆ¶è³‡æ–™ï¼‰
        function saveConnectionSettings() {
            const sheetId = document.getElementById('sheetId').value.trim();
            const appsScriptUrl = document.getElementById('appsScriptUrl').value.trim();

            if (sheetId) localStorage.setItem('investmentSheetId', sheetId);
            if (appsScriptUrl) localStorage.setItem('appsScriptUrl', appsScriptUrl);
            localStorage.setItem('currentUser', state.currentUser);
        }

        // èˆŠå‡½æ•¸ä¿ç•™ä½†æ”¹ç‚ºåªå„²å­˜é€£ç·šè¨­å®š
        function saveAllData() {
            saveConnectionSettings();
        }

        // èˆŠç‰ˆç›¸å®¹ï¼ˆä¿ç•™ï¼‰
        function saveHistoryData() {
            saveAllData();
        }

        // åªè¼‰å…¥é€£ç·šè¨­å®šï¼ˆSheet IDã€Apps Script URLï¼‰
        function loadSavedData() {
            // è¼‰å…¥ Sheet ID
            const savedSheetId = localStorage.getItem('investmentSheetId');
            if (savedSheetId) {
                Utils.setInputValue('sheetId', savedSheetId);
            }

            // è¼‰å…¥ Apps Script URL
            const savedAppsScriptUrl = localStorage.getItem('appsScriptUrl');
            if (savedAppsScriptUrl) {
                Utils.setInputValue('appsScriptUrl', savedAppsScriptUrl);
            }

            // ä¸å†å¾ localStorage è¼‰å…¥ç”¨æˆ¶è³‡æ–™
            // æ‰€æœ‰è³‡æ–™éƒ½å¾ Sheet è¼‰å…¥ï¼ˆåœ¨ autoLoadFromSheet ä¸­è™•ç†ï¼‰
        }

        // è¼‰å…¥èˆŠç‰ˆ localStorage è³‡æ–™ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
        // ========== å·¥å…·å‡½æ•¸ ==========
        function copyTemplate() {
            const templateId = '1QFHh9wdLXs7HnmlGDYFLZuMpMzUsv4go1SchPYFyrSA';
            window.open(`https://docs.google.com/spreadsheets/d/${templateId}/copy`, '_blank');
            showStatus('è«‹åœ¨æ–°è¦–çª—ä¸­å®Œæˆè¤‡è£½', 'success');
        }

        function extractSheetId(input) {
            let value = input.value.trim();
            if (value.includes('docs.google.com/spreadsheets')) {
                const match = value.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (match) input.value = match[1];
            }
        }

        function showStatus(message, type) {
            const el = document.getElementById('status');
            el.textContent = message;
            el.className = 'status ' + type;
        }
    </script>
</body>
</html>
